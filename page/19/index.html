<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="Simple & Freedom" type="application/atom+xml" />






<meta name="description" content="Learn and live.">
<meta property="og:type" content="website">
<meta property="og:title" content="Simple &amp; Freedom">
<meta property="og:url" content="http://arvin-he.github.io/page/19/index.html">
<meta property="og:site_name" content="Simple &amp; Freedom">
<meta property="og:description" content="Learn and live.">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Simple &amp; Freedom">
<meta name="twitter:description" content="Learn and live.">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://arvin-he.github.io/page/19/"/>





  <title>Simple & Freedom</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Simple & Freedom</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Learn and live.</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            公益404
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://arvin-he.github.io/2017/05/27/python-flask-context-2017-05-27/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Arvin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Simple & Freedom">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/27/python-flask-context-2017-05-27/" itemprop="url">Flask之上下文机制</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-27T11:29:30+08:00">
                2017-05-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="上下文（application-context-和-request-context）"><a href="#上下文（application-context-和-request-context）" class="headerlink" title="上下文（application context 和 request context）"></a>上下文（application context 和 request context）</h3><p>上下文是一个难理解的概念，在知乎的一个问题下面有个很通俗易懂的回答：</p>
<blockquote>
<p>每一段程序都有很多外部变量。只有像Add这种简单的函数才是没有外部变量的。一旦你的一段程序有了外部变量，这段程序就不完整，不能独立运行。你为了使他们运行，就要给所有的外部变量一个一个写一些值进去。这些值的集合就叫上下文。 – vzch</p>
</blockquote>
<p>flask中的上下文分两种，application context和request context，即应用上下文和请求上下文。这两者并不是全局与局部的关系，它们都处于一个请求的局部中。每个请求的g都是独立的，并且在整个请求内都是可访问修改的。</p>
<p>从一个 Flask App 读入配置并启动开始，就进入了 App Context，在其中我们可以访问配置文件、打开资源文件、通过路由规则反向构造 URL。<br>当一个请求进入开始被处理时，就进入了 Request Context，在其中我们可以访问请求携带的信息，比如 HTTP Method、表单域等。</p>
<h3 id="上下文对象的作用域"><a href="#上下文对象的作用域" class="headerlink" title="上下文对象的作用域"></a>上下文对象的作用域</h3><p>每个传给flask对象的请求，都是在不同的线程中处理，而且同一时刻每个线程只处理一个请求。所以对于每个请求来说，它们完全不用担心自己上下文中的数据被别的请求所修改。</p>
<p>然后就可以解释这个特性：从flask模块中引入的g、session、request、current_app是怎么做到同一个对象能在所有请求中使用并且不会冲突。</p>
<p>这两个上下文，一个保存请求本身的信息，一个保存处理过程中所用到的全局变量，从逻辑上也更为清晰。</p>
<p> Web 应用中每个线程（或 Greenlet）同时只处理一个请求，所以 App Context 对象和 Request Context 对象也是请求间隔离的。</p>
<h3 id="请求上下文"><a href="#请求上下文" class="headerlink" title="请求上下文"></a>请求上下文</h3><p>Flask中所有的请求处理都在“请求上下文”中进行，在它设计之初便就有这个概念。</p>
<ul>
<li>“请求上下文”是一个上下文对象，实现了<code>__enter__</code>和<code>__exit__</code>方法。可以使用with语句构造一个上下文环境。</li>
<li>进入上下文环境时，<code>_request_ctx_stack</code>这个栈中会推入一个<code>_RequestContext</code>对象。这个栈结构就是LocalStack栈。</li>
<li>推入栈中的<code>_RequestContext</code>对象有一些属性，包含了请求的的所有相关信息。例如app、request、session、g、flashes。还有一个url_adapter，这个对象可以进行URL匹配。</li>
<li>在with语句构造的上下文环境中可以进行请求处理。当退出上下文环境时，<code>_request_ctx_stack</code>这个栈会销毁刚才存储的上下文对象<br>以上的运行逻辑使得请求的处理始终在一个上下文环境中，这保证了请求处理过程不被干扰，而且请求上下文对象保存在LocalStack栈中，也很好地实现了线程/协程的隔离。</li>
</ul>
<p>以下是一个简单的例子：</p>
<p><img src="/2017/05/27/python-flask-context-2017-05-27/9.png" alt=""></p>
<p>上面的结果显示：<code>_request_ctx_stack</code>中为每一个线程创建了一个“键-值”对，每一“键-值”对中包含一个请求上下文对象。如果使用with语句，在离开上下文环境时栈中销毁存储的上下文对象信息。</p>
<p>请求上下文——0.9版本<br>在0.9版本中，Flask引入了“应用上下文”的概念，且对“请求上下文”的实现有一定的改变。主要有一下改变:</p>
<ul>
<li>请求上下文实现了push、pop方法，这使得对于请求上下文的操作更加的灵活；</li>
<li>伴随着请求上下文对象的生成并存储在栈结构中，Flask还会生成一个“应用上下文”对象，而且“应用上下文”对象也会存储在另一个栈结构中去。这是两个版本最大的不同。</li>
</ul>
<p><img src="/2017/05/27/python-flask-context-2017-05-27/10.png" alt=""></p>
<p>我们注意到，0.9版本的“请求上下文”的pop方法中，当要将一个“请求上下文”推入<code>_request_ctx_stack</code>栈中的时候，会先检查另一个栈<code>_app_ctx_stack</code>的栈顶是否存在“应用上下文”对象或者栈顶的“应用上下文”对象的应用是否是当前应用。如果不存在或者不是当前对象，Flask会自动先生成一个“应用上下文”对象，并将其推入<code>_app_ctx_stack</code>中。</p>
<p>注意到当要离开以上“请求上下文”环境的时候，Flask会先将“请求上下文”对象从<code>_request_ctx_stack</code>栈中销毁，之后会根据实际的情况确定销毁“应用上下文”对象。看下面代码:</p>
<p><img src="/2017/05/27/python-flask-context-2017-05-27/11.png" alt=""></p>
<h3 id="应用上下文"><a href="#应用上下文" class="headerlink" title="应用上下文"></a>应用上下文</h3><p>“应用上下文”存在的一个主要功能就是确定请求所在的应用。</p>
<p>疑问：既然“请求上下文”中也包含app等和当前应用相关的信息，那么只要调用<code>_request_ctx_stack.top.app</code>或者魔法<code>current_app</code>就可以确定请求所在的应用了，那为什么还需要“应用上下文”对象呢？<br>答案: 对于单应用单请求来说，使用“请求上下文”确实就可以了。<br>然而，Flask的设计理念之一就是多应用的支持。当在一个应用的请求上下文环境中，需要嵌套处理另一个应用的相关操作时，“请求上下文”显然就不能很好地解决问题了。</p>
<p>如何让请求找到“正确”的应用呢？<br>我们可能会想到，可以再增加一个请求上下文环境，并将其推入<code>_request_ctx_stack</code>栈中。由于两个上下文环境的运行是独立的，不会相互干扰，所以通过调用<code>_request_ctx_stack.top.app</code>或者魔法<code>current_app</code>也可以获得当前上下文环境正在处理那个应用。这种办法在一定程度上可行，但是如果对于第二个应用的处理不涉及到相关请求，那也就无从谈起“请求上下文”。</p>
<p>为了应对这个问题，Flask中将应用相关的信息单独拿出来，形成一个“应用上下文”对象。这个对象可以和“请求上下文”一起使用，也可以单独拿出来使用。<br>不过有一点需要<strong>注意的是</strong>：在创建“请求上下文”时<strong>一定要创建</strong>一个“应用上下文”对象。有了“应用上下文”对象，便可以很容易地确定当前处理哪个应用，这就是魔法<code>current_app</code>。在0.1版本中，<code>current_app</code>是对<code>_request_ctx_stack.top.app</code>的引用，而在0.9版本中<code>current_app</code>是对<code>_app_ctx_stack.top.app</code>的引用。<br>下面以一个多应用的例子进行说明：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># example - Flask v0.9</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, _request_ctx_stack, _app_ctx_stack</div><div class="line"><span class="comment"># 创建两个Flask应用</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>app = Flask(__name__)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>app2 = Flask(__name__)</div><div class="line"><span class="comment"># 先查看两个栈中的内容</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>_request_ctx_stack._local.__storage__</div><div class="line">&#123;&#125;</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>_app_ctx_stack._local.__storage__</div><div class="line">&#123;&#125;</div><div class="line"><span class="comment"># 构建一个app的请求上下文环境，在这个环境中运行app2的相关操作</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">with</span> app.test_request_context():</div><div class="line">        <span class="keyword">print</span> <span class="string">"Enter app's Request Context:"</span></div><div class="line">        <span class="keyword">print</span> _request_ctx_stack._local.__storage__</div><div class="line">        <span class="keyword">print</span> _app_ctx_stack._local.__storage__</div><div class="line">        <span class="keyword">print</span></div><div class="line">        <span class="keyword">with</span> app2.app_context():</div><div class="line">            <span class="keyword">print</span> <span class="string">"Enter app2's App Context:"</span></div><div class="line">            <span class="keyword">print</span> _request_ctx_stack._local.__storage__</div><div class="line">            <span class="keyword">print</span> _app_ctx_stack._local.__storage__</div><div class="line">            <span class="keyword">print</span></div><div class="line">            <span class="comment"># do something</span></div><div class="line">        <span class="keyword">print</span> <span class="string">"Exit app2's App Context:"</span></div><div class="line">        <span class="keyword">print</span> _request_ctx_stack._local.__storage__</div><div class="line">        <span class="keyword">print</span> _app_ctx_stack._local.__storage__</div><div class="line">        <span class="keyword">print</span></div><div class="line"><span class="comment"># Result</span></div><div class="line">Enter app<span class="string">'s Request Context:</span></div><div class="line"><span class="string">&#123;&lt;greenlet.greenlet object at 0x000000000727A178&gt;: &#123;'</span>stack<span class="string">': [&lt;RequestContext '</span>http://localhost/<span class="string">' [GET] of __main__&gt;]&#125;&#125;</span></div><div class="line"><span class="string">&#123;&lt;greenlet.greenlet object at 0x000000000727A178&gt;: &#123;'</span>stack<span class="string">': [&lt;flask.ctx.AppContext object at 0x0000000005DD0DD8&gt;]&#125;&#125;</span></div><div class="line"><span class="string">Enter app2'</span>s App Context:</div><div class="line">&#123;&lt;greenlet.greenlet object at <span class="number">0x000000000727A178</span>&gt;: &#123;<span class="string">'stack'</span>: [&lt;RequestContext <span class="string">'http://localhost/'</span> [GET] of __main__&gt;]&#125;&#125;</div><div class="line">&#123;&lt;greenlet.greenlet object at <span class="number">0x000000000727A178</span>&gt;: &#123;<span class="string">'stack'</span>: [&lt;flask.ctx.AppContext object at <span class="number">0x0000000005DD0DD8</span>&gt;, &lt;flask.ctx.AppContext object at <span class="number">0x0000000007313198</span>&gt;]&#125;&#125;</div><div class="line">Exit app2<span class="string">'s App Context</span></div><div class="line"><span class="string">&#123;&lt;greenlet.greenlet object at 0x000000000727A178&gt;: &#123;'</span>stack<span class="string">': [&lt;RequestContext '</span>http://localhost/<span class="string">' [GET] of __main__&gt;]&#125;&#125;</span></div><div class="line"><span class="string">&#123;&lt;greenlet.greenlet object at 0x000000000727A178&gt;: &#123;'</span>stack<span class="string">': [&lt;flask.ctx.AppContext object at 0x0000000005DD0DD8&gt;]&#125;&#125;</span></div></pre></td></tr></table></figure>
<p>在以上的例子中：</p>
<p>我们首先创建了两个Flask应用app和app2；</p>
<p>接着我们构建了一个app的请求上下文环境。当进入这个环境中时，这时查看两个栈的内容，发现两个栈中已经有了当前请求的请求上下文对象和应用上下文对象。并且栈顶的元素都是app的请求上下文和应用上下文；</p>
<p>之后，我们再在这个环境中嵌套app2的应用上下文。当进入app2的应用上下文环境时，两个上下文环境便隔离开来，此时再查看两个栈的内容，发现<code>_app_ctx_stack</code>中推入了app2的应用上下文对象，并且栈顶指向它。这时在app2的应用上下文环境中，<code>current_app</code>便会一直指向app2；</p>
<p>当离开app2的应用上下文环境，<code>_app_ctx_stack</code>栈便会销毁app2的应用上下文对象。这时查看两个栈的内容，发现两个栈中只有app的请求的请求上下文对象和应用上下文对象。</p>
<p>最后，离开app的请求上下文环境后，两个栈便会销毁app的请求的请求上下文对象和应用上下文对象，栈为空。</p>
<h3 id="与上下文对象有关的“全局变量”"><a href="#与上下文对象有关的“全局变量”" class="headerlink" title="与上下文对象有关的“全局变量”"></a>与上下文对象有关的“全局变量”</h3><p>Flask中使用的一些“全局变量”，包括<code>current_app</code>、<code>request</code>、<code>session</code>、<code>g</code>等都来自于上下文对象。<br>其中<code>current_app</code>一直指向<code>_app_ctx_stack</code>栈顶的“应用上下文”对象，是对当前应用的引用。<br>而request、session、g等一直指向<code>_request_ctx_stack</code>栈顶的“请求上下文”对象，分别引用请求上下文的request、session和g。不过，从 Flask 0.10 起，对象 g 存储在应用上下文中而不再是请求上下文中。</p>
<h3 id="两种上下文分析"><a href="#两种上下文分析" class="headerlink" title="两种上下文分析"></a>两种上下文分析</h3><p>当 <code>app = Flask(__name__)</code> 构造出一个 Flask App 时，App Context 并不会被自动推入 Stack 中。所以此时 Local Stack 的栈顶是空的，current_app 也是 unbound 状态。</p>
<p><img src="/2017/05/27/python-flask-context-2017-05-27/1.png" alt=""></p>
<p>这也是一些 Flask 用户可能被坑的地方, 比如编写一个离线脚本时，如果直接在一个 Flask-SQLAlchemy 写成的 Model 上调用 <code>User.query.get(user_id)</code>，就会遇到 RuntimeError。因为此时 App Context 还没被推入栈中，而 Flask-SQLAlchemy 需要数据库连接信息时就会去取 <code>current_app.config</code>，current_app 指向的却是 <code>_app_ctx_stack</code> 为空的栈顶。</p>
<p>解决的办法是运行脚本正文之前，先将 App 的 App Context 推入栈中，栈顶不为空后 current_app 这个 Local Proxy 对象就自然能将“取 config 属性” 的动作转发到当前 App 上了：</p>
<p><img src="/2017/05/27/python-flask-context-2017-05-27/2.png" alt=""></p>
<p>那么为什么在应用运行时不需要手动 <code>app_context().push()</code> 呢？<br>因为 Flask App 在作为 WSGI Application 运行时，会在每个请求进入的时候将请求上下文推入 <code>_request_ctx_stack</code> 中，而请求上下文一定是 App 上下文之中，所以推入部分的逻辑有这样一条：如果发现 <code>_app_ctx_stack</code> 为空，则隐式地推入一个 App 上下文。</p>
<p>所以，请求中是不需要手动推上下文入栈的，但是离线脚本需要手动推入 App Context。如果没有什么特殊困难，我更建议用 Flask-Script 来写离线任务。</p>
<h3 id="两个疑问"><a href="#两个疑问" class="headerlink" title="两个疑问"></a>两个疑问</h3><ol>
<li><p>为什么 App Context 要独立出来：既然在 Web 应用运行时里，App Context 和 Request Context 都是 Thread Local 的，那么为什么还要独立二者？</p>
</li>
<li><p>为什么要放在“栈”里：在 Web 应用运行时中，一个线程同时只处理一个请求，那么 <code>_req_ctx_stack</code> 和 <code>_app_ctx_stack</code> 肯定都是只有一个栈顶元素的。那么为什么还要用“栈”这种结构？</p>
</li>
</ol>
<p>答案:这两个做法给予我们多个 Flask App 共存和非 Web Runtime 中灵活控制 Context 的可能性。</p>
<p>我们知道对一个 Flask App 调用 app.run() 之后，进程就进入阻塞模式并开始监听请求。此时是不可能再让另一个 Flask App 在主线程运行起来的。<br>那么还有哪些场景需要多个 Flask App 共存呢？<br>前面提到了，一个 Flask App 实例就是一个 WSGI Application，那么 WSGI Middleware 是允许使用组合模式的.比如:</p>
<p><img src="/2017/05/27/python-flask-context-2017-05-27/3.png" alt=""></p>
<p>这个例子就利用 Werkzeug 内置的 Middleware 将两个 Flask App 组合成一个一个 WSGI Application。这种情况下两个 App 都同时在运行，只是根据 URL 的不同而将请求分发到不同的 App 上处理。</p>
<p>需要注意的是，这种用法和 Flask 的 Blueprint 是有区别的。Blueprint 虽然和这种用法很类似，但前者自己没有 App Context，只是同一个 Flask App 内部整理资源的一种方式，所以多个 Blueprint 可能共享了同一个 Flask App；后者面向的是所有 WSGI Application，而不仅仅是 Flask App，即使是把一个 Django App 和一个 Flask App 用这种用法整合起来也是可行的。</p>
<p>如果仅仅在 Web Runtime 中，多个 Flask App 同时工作倒不是问题。毕竟每个请求被处理的时候是身处不同的 Thread Local 中的。但是 Flask App 不一定仅仅在 Web Runtime 中被使用 —— 有两个典型的场景是在非 Web 环境需要访问上下文代码的，一个是离线脚本（前面提到过），另一个是测试。这两个场景即所谓的“Running code outside of a request”。</p>
<h3 id="在非-Web-环境运行-Flask-关联的代码"><a href="#在非-Web-环境运行-Flask-关联的代码" class="headerlink" title="在非 Web 环境运行 Flask 关联的代码"></a>在非 Web 环境运行 Flask 关联的代码</h3><p>离线脚本或者测试这类非 Web 环境和和 Web 环境不同 —— 前者一般只在主线程运行。</p>
<p>设想，一个离线脚本需要操作两个 Flask App 关联的上下文，应该怎么办呢？这时候栈结构的 App Context 优势就发挥出来了。</p>
<p><img src="/2017/05/27/python-flask-context-2017-05-27/4.png" alt=""></p>
<p>无论有多少个 App，只要主动去 Push 它的 App Context，Context Stack 中就会累积起来。这样，栈顶永远是当前操作的 App Context。当一个 App Context 结束的时候，相应的栈顶元素也随之出栈。如果在执行过程中抛出了异常，对应的 App Context 中注册的 teardown 函数被传入带有异常信息的参数。</p>
<p>这么一来就解释了两个疑问, 在这种单线程运行环境中，只有栈结构才能保存多个 Context 并在其中定位出哪个才是“当前”。而离线脚本只需要 App 关联的上下文，<strong>不需要构造出请求</strong>，所以 App Context 也应该和 Request Context 分离。这也就解释了为什么需要两个上下文了.</p>
<p>另一个手动推入 Context 的场景是测试。测试中我们可能会需要构造一个请求，并验证相关的状态是否符合预期。例如：</p>
<p><img src="/2017/05/27/python-flask-context-2017-05-27/5.png" alt=""></p>
<p>这里调用 client.get 时，Request Context 就被推入了。其特点和 App Context 非常类似，这里不再赘述。</p>
<h3 id="为何建议使用-App-Factory-模式"><a href="#为何建议使用-App-Factory-模式" class="headerlink" title="为何建议使用 App Factory 模式"></a>为何建议使用 App Factory 模式</h3><p>从官方文档来看，Flask 有 Singleton(单例) 和 App Factory 两种用法。<br>前一种用法和其他的一些 Web 框架（如 Bottle、Sinatra）的门面广告很相似，因为代码精简，所以显得非常的“帅”：</p>
<p><img src="/2017/05/27/python-flask-context-2017-05-27/6.png" alt=""></p>
<p>但是这种“帅”是有代价的。一个最麻烦的问题就是编写测试的时候：</p>
<p><img src="/2017/05/27/python-flask-context-2017-05-27/7.png" alt=""></p>
<p>在上面的例子中，我为了测试给 App 新挂载了一个 View 函数。这是很常见的一个测试需求。但是如果 Flask App 实例是单例的，这种做法就会“弄脏”下一个测试的运行。更加麻烦的是，上述例子中如果 test_home 在 test_app 之前运行了，Flask 的开发者防御机制会认为这是一个“已经开始处理 Web 请求了，又挂载了视图”的失误，从而抛出 RuntimeError。</p>
<p>所以除非是应用简单到不需要 Web 层测试，否则还是尽量使用 App Factory 模式比较好。况且配合 Blueprint 的情况下，App Factory 还能帮助我们良好地组织应用结构：</p>
<p><img src="/2017/05/27/python-flask-context-2017-05-27/8.png" alt=""></p>
<p>这样就能彻底摆脱 app.py 和 View 模块“互相 Import”的纠结了。</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="http://blog.csdn.net/barrysj/article/details/51519254" target="_blank" rel="external">http://blog.csdn.net/barrysj/article/details/51519254</a></li>
<li><a href="https://blog.tonyseek.com/post/the-context-mechanism-of-flask/" target="_blank" rel="external">https://blog.tonyseek.com/post/the-context-mechanism-of-flask/</a></li>
<li><a href="http://fanchunke.me/Flask/Flask%E4%B8%AD%E7%9A%84%E8%AF%B7%E6%B1%82%E4%B8%8A%E4%B8%8B%E6%96%87%E5%92%8C%E5%BA%94%E7%94%A8%E4%B8%8A%E4%B8%8B%E6%96%87/" target="_blank" rel="external">http://fanchunke.me/Flask/Flask%E4%B8%AD%E7%9A%84%E8%AF%B7%E6%B1%82%E4%B8%8A%E4%B8%8B%E6%96%87%E5%92%8C%E5%BA%94%E7%94%A8%E4%B8%8A%E4%B8%8B%E6%96%87/</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://arvin-he.github.io/2017/05/25/python-wsgi-2017-05-25/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Arvin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Simple & Freedom">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/25/python-wsgi-2017-05-25/" itemprop="url">Python之WSGI</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-25T13:17:45+08:00">
                2017-05-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="WSGI概念"><a href="#WSGI概念" class="headerlink" title="WSGI概念"></a>WSGI概念</h3><p>我们先看一下面向 http 的 python 程序需要关心哪些内容：</p>
<ul>
<li>请求<ul>
<li>请求的方法 method</li>
<li>请求的地址 url</li>
<li>请求的内容</li>
<li>请求的头部 header</li>
<li>请求的环境信息</li>
</ul>
</li>
<li>响应<ul>
<li>状态码 status_code</li>
<li>响应的数据</li>
<li>响应的头部</li>
</ul>
</li>
</ul>
<p>WSGI（Web Server Gateway Interface） 的任务就是把上面的数据在 http server 和 python 应用程序之间简单友好地传递。<br>它是一个标准，被定义在PEP 333。需要 http server 和 python 应用程序都要遵守一定的规范，实现这个标准的约定内容，才能正常工作。</p>
<h3 id="应用程序端"><a href="#应用程序端" class="headerlink" title="应用程序端"></a>应用程序端</h3><p>WSGI 规定每个 python 程序（Application）必须是一个可调用的对象（实现了__call__ 函数的方法或者类），<br>接受两个参数 environ（WSGI 的环境信息） 和 start_response（开始响应请求的函数），并且返回 iterable。</p>
<p>几点说明：</p>
<ul>
<li>environ 和 start_response 由 http server 提供并实现</li>
<li>environ 变量是包含了环境信息的字典</li>
<li>Application 内部在返回前调用 start_response</li>
<li>start_response也是一个 callable，接受两个必须的参数，status（HTTP状态）和 response_headers（响应消息的头）</li>
<li>可调用对象要返回一个值，这个值是可迭代的。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"> <span class="comment"># 1. 可调用对象是一个函数,函数都是可调用的</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">application</span><span class="params">(environ, start_response)</span>:</span></div><div class="line">   response_body = <span class="string">'The request method was %s'</span> % environ[<span class="string">'REQUEST_METHOD'</span>]</div><div class="line">   <span class="comment"># HTTP response code and message</span></div><div class="line">   status = <span class="string">'200 OK'</span></div><div class="line">   <span class="comment"># 应答的头部是一个列表，每对键值都必须是一个 tuple。</span></div><div class="line">   response_headers = [(<span class="string">'Content-Type'</span>, <span class="string">'text/plain'</span>),</div><div class="line">                       (<span class="string">'Content-Length'</span>, str(len(response_body)))]</div><div class="line">   <span class="comment"># 调用服务器程序提供的 start_response，填入两个参数</span></div><div class="line">   start_response(status, response_headers)</div><div class="line">   <span class="comment"># 返回必须是 iterable</span></div><div class="line">   <span class="keyword">return</span> [response_body]	</div><div class="line">   </div><div class="line"><span class="comment"># 2. 可调用对象是一个类</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppClass</span>:</span></div><div class="line">	<span class="string">"""这里的可调用对象就是 AppClass 这个类，调用它就能生成可以迭代的结果。</span></div><div class="line"><span class="string">		使用方法类似于： </span></div><div class="line"><span class="string">		for result in AppClass(env, start_response):</span></div><div class="line"><span class="string">		     do_somthing(result)</span></div><div class="line"><span class="string">	"""</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, environ, start_response)</span>:</span></div><div class="line">        self.environ = environ</div><div class="line">        self.start = start_response</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__iter__</span><span class="params">(self)</span>:</span></div><div class="line">        status = <span class="string">'200 OK'</span></div><div class="line">        response_headers = [(<span class="string">'Content-type'</span>, <span class="string">'text/plain'</span>)]</div><div class="line">        self.start(status, response_headers)</div><div class="line">        <span class="keyword">yield</span> <span class="string">"Hello world!\n"</span></div><div class="line"></div><div class="line"><span class="comment"># 3. 可调用对象是一个实例 </span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppClass</span>:</span></div><div class="line">	<span class="string">"""这里的可调用对象就是 AppClass 的实例，使用方法类似于： </span></div><div class="line"><span class="string">		app = AppClass()</span></div><div class="line"><span class="string">		for result in app(environ, start_response):</span></div><div class="line"><span class="string">		     do_somthing(result)</span></div><div class="line"><span class="string">	"""</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">pass</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, environ, start_response)</span>:</span></div><div class="line">        status = <span class="string">'200 OK'</span></div><div class="line">        response_headers = [(<span class="string">'Content-type'</span>, <span class="string">'text/plain'</span>)]</div><div class="line">        self.start(status, response_headers)</div><div class="line">        <span class="keyword">yield</span> <span class="string">"Hello world!\n"</span></div></pre></td></tr></table></figure>
<h3 id="服务器程序端"><a href="#服务器程序端" class="headerlink" title="服务器程序端"></a>服务器程序端</h3><p>标准要能够确切地实行，必须要求程序端和服务器端共同遵守。<br>上面提到， envrion 和 start_response 都是服务器端提供的。</p>
<p>下面就看看，服务器端要履行的义务:<br>准备 environ 参数<br>定义 start_response 函数<br>调用程序端的可调用对象</p>
<p>PEP 333 里给出了一个 wsgi server 的简单实现，我又简化了一下——去除一些异常处理和判断，添加了一点注释：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> os, sys</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_with_cgi</span><span class="params">(application)</span>:</span>    <span class="comment"># application 是程序端的可调用对象</span></div><div class="line">	<span class="comment"># 准备 environ 参数，这是一个字典，里面的内容是一次 HTTP 请求的环境变量</span></div><div class="line">    environ = dict(os.environ.items())</div><div class="line">    environ[<span class="string">'wsgi.input'</span>]        = sys.stdin</div><div class="line">    environ[<span class="string">'wsgi.errors'</span>]       = sys.stderr</div><div class="line">    environ[<span class="string">'wsgi.version'</span>]      = (<span class="number">1</span>, <span class="number">0</span>)</div><div class="line">    environ[<span class="string">'wsgi.multithread'</span>]  = <span class="keyword">False</span></div><div class="line">    environ[<span class="string">'wsgi.multiprocess'</span>] = <span class="keyword">True</span></div><div class="line">    environ[<span class="string">'wsgi.run_once'</span>]     = <span class="keyword">True</span>	        </div><div class="line">    environ[<span class="string">'wsgi.url_scheme'</span>] = <span class="string">'http'</span></div><div class="line"></div><div class="line">    headers_set = []</div><div class="line">    headers_sent = []</div><div class="line"></div><div class="line">	<span class="comment"># 把应答的结果输出到终端</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">write</span><span class="params">(data)</span>:</span></div><div class="line">        sys.stdout.write(data)</div><div class="line">        sys.stdout.flush()</div><div class="line"></div><div class="line">	<span class="comment"># 实现 start_response 函数，根据程序端传过来的 status 和 response_headers 参数，</span></div><div class="line">	<span class="comment"># 设置状态和头部</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start_response</span><span class="params">(status, response_headers, exc_info=None)</span>:</span></div><div class="line">        headers_set[:] = [status, response_headers]</div><div class="line">      	<span class="keyword">return</span> write</div><div class="line"></div><div class="line">	<span class="comment"># 调用客户端的可调用对象，把准备好的参数传递过去</span></div><div class="line">    result = application(environ, start_response)</div><div class="line">    </div><div class="line">    <span class="comment"># 处理得到的结果，这里简单地把结果输出到标准输出。</span></div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        <span class="keyword">for</span> data <span class="keyword">in</span> result:</div><div class="line">            <span class="keyword">if</span> data:    <span class="comment"># don't send headers until body appears</span></div><div class="line">                write(data)</div><div class="line">    <span class="keyword">finally</span>:</div><div class="line">        <span class="keyword">if</span> hasattr(result, <span class="string">'close'</span>):</div><div class="line">            result.close()</div></pre></td></tr></table></figure></p>
<h3 id="中间层-middleware"><a href="#中间层-middleware" class="headerlink" title="中间层 middleware"></a>中间层 middleware</h3><p>有些程序可能处于服务器端和程序端两者之间：对于服务器程序，它就是应用程序；而对于应用程序，它就是服务器程序。这就是中间层 middleware。middleware 对服务器程序和应用是透明的，它像一个代理/管道一样，把接收到的请求进行一些处理，然后往后传递，一直传递到客户端程序，最后把程序的客户端处理的结果再返回。</p>
<p>middleware 做了两件事情：</p>
<ul>
<li>被服务器程序（有可能是其他 middleware）调用，返回结果回去</li>
<li>调用应用程序（有可能是其他 middleware），把参数传递过去</li>
</ul>
<p>PEP 333 上面给出了 middleware 的可能使用场景：</p>
<ul>
<li>根据 url 把请求给到不同的客户端程序（url routing）</li>
<li>允许多个客户端程序/web 框架同时运行，就是把接到的同一个请求传递给多个程序。</li>
<li>负载均衡和远程处理：把请求在网络上传输</li>
<li>应答的过滤处理</li>
</ul>
<p>那么简单地 middleware 实现是怎么样的呢？下面的代码实现的是一个简单地 url routing 的 middleware：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Router</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        self.path_info = &#123;&#125;</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">route</span><span class="params">(self, environ, start_response)</span>:</span></div><div class="line">        application = self.path_info[environ[<span class="string">'PATH_INFO'</span>]]</div><div class="line">        <span class="keyword">return</span> application(environ, start_response)</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, path)</span>:</span></div><div class="line">        <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(application)</span>:</span></div><div class="line">            self.path_info[path] = application</div><div class="line">        <span class="keyword">return</span> wrapper</div><div class="line"></div><div class="line">router = Router()</div></pre></td></tr></table></figure></p>
<p>怎么在程序里面使用呢？<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#here is the application</span></div><div class="line"><span class="meta">@router('/hello')	#调用 route 实例，把函数注册到 paht_info 字典</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">(environ, start_response)</span>:</span></div><div class="line">    status = <span class="string">'200 OK'</span></div><div class="line">    output = <span class="string">'Hello'</span></div><div class="line">    response_headers = [(<span class="string">'Content-type'</span>, <span class="string">'text/plain'</span>),</div><div class="line">                        (<span class="string">'Content-Length'</span>, str(len(output)))]</div><div class="line">    write = start_response(status, response_headers)</div><div class="line">    <span class="keyword">return</span> [output]</div><div class="line"></div><div class="line"><span class="meta">@router('/world')</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">world</span><span class="params">(environ, start_response)</span>:</span></div><div class="line">    status = <span class="string">'200 OK'</span></div><div class="line">    output = <span class="string">'World!'</span></div><div class="line">    response_headers = [(<span class="string">'Content-type'</span>, <span class="string">'text/plain'</span>),</div><div class="line">                        (<span class="string">'Content-Length'</span>, str(len(output)))]</div><div class="line">    write = start_response(status, response_headers)</div><div class="line">    <span class="keyword">return</span> [output]</div><div class="line"></div><div class="line"><span class="comment">#here run the application</span></div><div class="line">result = router.route(environ, start_response)</div><div class="line"><span class="keyword">for</span> value <span class="keyword">in</span> result: </div><div class="line">    write(value)</div></pre></td></tr></table></figure></p>
<h3 id="想要更多的话，就去看-PEP333，文档里还有下面更多的知识："><a href="#想要更多的话，就去看-PEP333，文档里还有下面更多的知识：" class="headerlink" title="想要更多的话，就去看 PEP333，文档里还有下面更多的知识："></a>想要更多的话，就去看 PEP333，文档里还有下面更多的知识：</h3><ul>
<li>错误处理</li>
<li>environ 变量包含哪些值，都是什么意思。</li>
<li>输入和输出的细节</li>
<li>start_response 的更多规范</li>
<li>content-length 等头部规范</li>
<li>缓存和文本流</li>
<li>unicode 和多语言处理</li>
<li>……</li>
</ul>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="http://legacy.python.org/dev/peps/pep-0333/#rationale-and-goals" target="_blank" rel="external">官方文档 PEP333</a></li>
<li><a href="http://lucumr.pocoo.org/2007/5/21/getting-started-with-wsgi/" target="_blank" rel="external">Getting Started with WSGI</a></li>
<li><a href="http://cizixs.com/2014/11/08/understand-wsgi" target="_blank" rel="external">http://cizixs.com/2014/11/08/understand-wsgi</a></li>
<li><a href="http://blog.csdn.net/yangz_xx/article/details/37508909" target="_blank" rel="external">http://blog.csdn.net/yangz_xx/article/details/37508909</a></li>
<li><a href="https://docs.python.org/2/library/wsgiref.html" target="_blank" rel="external">wsgiref：官方的 wsgi 实现，包括客户端和服务器端</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://arvin-he.github.io/2017/05/25/vscode-config-plugins-2017-05-25/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Arvin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Simple & Freedom">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/25/vscode-config-plugins-2017-05-25/" itemprop="url">vscode插件和配置</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-25T10:14:46+08:00">
                2017-05-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/工具/" itemprop="url" rel="index">
                    <span itemprop="name">工具</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="插件"><a href="#插件" class="headerlink" title="插件"></a>插件</h3><p>Align<br>Beautify<br>C/C++<br>Emoji Code<br>HTML Snippets<br>JavaScript(ES6) code snippets<br>jsx<br>One Dark Theme<br>Path Intellisense<br>Python<br>Reactjs code snippets<br>Runner<br>vscode-icons</p>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>{<br>    “[cpp]”: {<br>        “editor.quickSuggestions”: false<br>    },<br>    “[c]”: {<br>        “editor.quickSuggestions”: false<br>    },<br>    // “editor.wordWrap”: “bounded”,<br>    // “editor.wordWrapColumn”: 80,<br>    // 控制字体系列<br>    “editor.fontFamily”: “Consolas, ‘Courier New’, monospace, ‘宋体’”,<br>    // 以像素为单位控制字号。<br>    “editor.fontSize”: 16,<br>    // 控制选取范围是否有圆角<br>    “editor.roundedSelection”: false,<br>    // 建议小组件的字号<br>    “editor.suggestFontSize”: 14,<br>    // 在“打开的编辑器”窗格中显示的编辑器数量。将其设置为 0 可隐藏窗格。<br>    “explorer.openEditors.visible”: 0,<br>    // 是否已启用自动刷新<br>    “git.autorefresh”: false,<br>    // 是否启用了自动提取。<br>    “git.autofetch”: false,<br>    // 以像素为单位控制终端的字号，这是 editor.fontSize 的默认值。<br>    “terminal.integrated.fontSize”: 16,<br>    // 控制终端游标是否闪烁。<br>    “terminal.integrated.cursorBlinking”: true,<br>    // 一个制表符等于的空格数。该设置在 <code>editor.detectIndentation</code> 启用时根据文件内容进行重写。<br>    “editor.tabSize”: 4,<br>    “editor.minimap.enabled”: false,<br>    // Tab Size<br>    “beautify.tabSize”: 4,</p>
<pre><code>&quot;python.linting.pylintEnabled&quot;: false,
&quot;python.linting.pep8Enabled&quot;: true,
&quot;files.autoSave&quot;: &quot;afterDelay&quot;,
&quot;files.autoSaveDelay&quot;: 1000,
&quot;workbench.iconTheme&quot;: &quot;vscode-icons&quot;,
&quot;window.zoomLevel&quot;: 1,
&quot;workbench.colorTheme&quot;: &quot;Monokai&quot;
</code></pre><p>}</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://arvin-he.github.io/2017/05/25/node-vue-setup-2017-05-25/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Arvin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Simple & Freedom">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/25/node-vue-setup-2017-05-25/" itemprop="url">NodeJS/Vue安装</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-25T09:26:58+08:00">
                2017-05-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="node简介"><a href="#node简介" class="headerlink" title="node简介"></a>node简介</h3><p>简单的说 Node.js 就是运行在服务端的 JavaScript。<br>Node.js 是一个基于 Chrome V8 引擎的 JavaScript 运行环境。<br>Node.js 使用了一个事件驱动、非阻塞式 I/O 的模型，使其轻量又高效。<br>Node.js 的包管理器 npm，是全球最大的开源库生态系统。</p>
<h3 id="node安装"><a href="#node安装" class="headerlink" title="node安装"></a>node安装</h3><p>windows下的NodeJS安装是比较方便的（v0.6.0版本之后，支持windows native），<br>只需要登陆官网 <a href="http://nodejs.org/" target="_blank" rel="external">node官网</a>，便可以看到首页的“INSTALL”按钮，直接点击就会自动下载安装了。</p>
<p>安装完成后可以使用cmd（win+r然后输入cmd进入）测试下是否安装成功。<br>方法：在cmd下输入node -v，出现版本提示就是完成了NodeJS的安装。</p>
<p>npm的安装。由于新版的NodeJS已经集成了npm，所以之前npm也一并安装好了。<br>同样可以使用cmd命令行输入”npm -v”来测试是否成功安装。出现版本提示便是已经安装好了。</p>
<h3 id="vue简介"><a href="#vue简介" class="headerlink" title="vue简介"></a>vue简介</h3><p>Vue.js是一套构建用户界面的渐进式框架。与其他重量级框架不同的是，Vue 采用自底向上增量开发的设计。<br>Vue 的核心库只关注视图层，并且非常容易学习，非常容易与其它库或已有项目整合。<br>另一方面，Vue 完全有能力驱动采用单文件组件和Vue生态系统支持的库开发的复杂单页应用。<br>Vue.js 的目标是通过尽可能简单的 API 实现响应的数据绑定和组合的视图组件。<br>Vue.js是一个MVVM模式的框架.</p>
<h3 id="安装cnpm"><a href="#安装cnpm" class="headerlink" title="安装cnpm"></a>安装cnpm</h3><p>由于有些npm有些资源被屏蔽或者是国外资源的原因，经常会导致用npm安装依赖包的时候失败或者速度非常慢，所有需要npm的国内镜像-cnpm.<br>在命令行中输入:<code>npm install -g cnpm --registry=http://registry.npm.taobao.org</code>,回车然后等待安装,<br>完成之后，就可以用cnpm代替npm来安装依赖包了。如果想进一步了解cnpm的，查看淘宝npm镜像官网。</p>
<h3 id="vue安装"><a href="#vue安装" class="headerlink" title="vue安装"></a>vue安装</h3><p>在命令行输入:<code>cnpm install -g vue-cli</code>,回车,等待安装</p>
<h3 id="用vue-cli构建项目"><a href="#用vue-cli构建项目" class="headerlink" title="用vue-cli构建项目"></a>用vue-cli构建项目</h3><p>要创建项目，首先我们要选定目录，然后再命令行中把目录转到选定的目录.<br>下面创建一个vueflask项目,在命令行输入命令:<code>vue init webpack vueflask</code>,回车.<br>这个命令是初始化一个项目，其中webpack是构建工具，也就是整个项目是基于webpack的。其中vueflask是整个项目文件夹的名称，这个文件夹会自动生成在你指定的目录中.<br>运行初始化命令的时候回让用户输入几个基本的选项，如项目名称，描述，作者等信息，如果不想填直接回车默认就好.<br>整个项目的目录结构，我们主要在src目录中做修改。这个项目现在还只是一个结构框架，整个项目需要的依赖资源都还没有安装</p>
<h3 id="安装项目所需的依赖"><a href="#安装项目所需的依赖" class="headerlink" title="安装项目所需的依赖"></a>安装项目所需的依赖</h3><p>要安装依赖包，首先cd到项目文件夹(vueflask文件夹)，然后运行命令<code>cnpm install</code> ，等待安装。<br>安装完成之后，会在我们的项目目录vueflask文件夹中多出一个node_modules文件夹，这里边就是我们项目需要的依赖包资源。<br>安装完依赖包之后，就可以运行整个项目了。</p>
<h3 id="运行vue项目"><a href="#运行vue项目" class="headerlink" title="运行vue项目"></a>运行vue项目</h3><p>在项目目录中，运行命令<code>npm run dev</code>或<code>cnpm run dev</code> ，会用热加载的方式运行我们的应用，热加载可以在修改完代码后不用手动刷新浏览器就能实时看到修改后的效果。<br>关于<code>npm run dev</code>命令，其中的“run”对应的是package.json文件中，scripts字段中的dev，也就是<code>node build/dev-server.js</code>命令的一个快捷方式。<br> 项目运行成功后，浏览器会自动打开localhost:8080（如果浏览器没有自动打开，可以手动输入）。运行成功后，会看到如下所示的界面。</p>
<p> <img src="/2017/05/25/node-vue-setup-2017-05-25/1.png" alt=""></p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="http://www.cnblogs.com/qdrw/articles/6380091.html" target="_blank" rel="external">http://www.cnblogs.com/qdrw/articles/6380091.html</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://arvin-he.github.io/2017/05/24/python-generator-2017-05-24/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Arvin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Simple & Freedom">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/24/python-generator-2017-05-24/" itemprop="url">Python之生成器</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-24T15:15:24+08:00">
                2017-05-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="容器-container"><a href="#容器-container" class="headerlink" title="容器(container)"></a>容器(container)</h3><p>容器是一种把多个元素组织在一起的数据结构，容器中的元素可以逐个地迭代获取，可以用 in, not in关键字判断元素是否包含在容器中。<br>在Python中，常见的容器对象有：<br>list, deque, ….<br>set, frozensets, ….<br>dict, defaultdict, OrderedDict, Counter, ….<br>tuple, namedtuple, …<br>str</p>
<p>尽管绝大多数容器都提供了某种方式来获取其中的每一个元素，但这并不是容器本身提供的能力，而是可迭代对象赋予了容器这种能力，<br>当然并不是所有的容器都是可迭代的，比如：Bloom filter，虽然Bloom filter可以用来检测某个元素是否包含在容器中，<br>但是并不能从容器中获取其中的每一个值，因为Bloom filter压根就没把元素存储在容器中，而是通过一个散列函数映射成一个值保存在数组中。</p>
<h3 id="可迭代对象-iterable"><a href="#可迭代对象-iterable" class="headerlink" title="可迭代对象(iterable)"></a>可迭代对象(iterable)</h3><p>很多容器都是可迭代对象，此外还有更多的对象同样也是可迭代对象，比如处于打开状态的files，sockets等等。但凡是可以返回一个迭代器的对象都可称之为可迭代对象.<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>x = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>y = iter(x)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>z = iter(x)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>next(y)</div><div class="line"><span class="number">1</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>next(y)</div><div class="line"><span class="number">2</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>next(z)</div><div class="line"><span class="number">1</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>type(x)</div><div class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">list</span>'&gt;</span></div><div class="line"><span class="class">&gt;&gt;&gt; <span class="title">type</span><span class="params">(y)</span></span></div><div class="line"><span class="class">&lt;<span class="title">class</span> '<span class="title">list_iterator</span>'&gt;</span></div></pre></td></tr></table></figure></p>
<p>这里 x 是一个可迭代对象，可迭代对象和容器一样是一种通俗的叫法，并不是指某种具体的数据类型，list是可迭代对象，dict是可迭代对象，set也是可迭代对象。<br>y 和 z 是两个独立的迭代器，迭代器内部持有一个状态，该状态用于记录当前迭代所在的位置，以方便下次迭代的时候获取正确的元素。<br>迭代器有一种具体的迭代器类型，比如 list_iterator， set_iterator。<br>可迭代对象实现了 __iter__和 __next__方法（python2中是 next方法，python3是 <strong>next</strong>方法），这两个方法对应内置函数 iter()和 next()。<br>__iter__方法返回可迭代对象本身，这使得他既是一个可迭代对象同时也是一个迭代器。<br>当运行下面代码:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">x = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</div><div class="line"><span class="keyword">for</span> elem <span class="keyword">in</span> x:</div><div class="line">    ...</div></pre></td></tr></table></figure></p>
<p>实际执行情况是:</p>
<p><img src="/2017/05/24/python-generator-2017-05-24/1.png" alt=""></p>
<h3 id="迭代器-iterator"><a href="#迭代器-iterator" class="headerlink" title="迭代器(iterator)"></a>迭代器(iterator)</h3><p>迭代器就是用于迭代操作（for 循环）的对象，它像列表一样可以迭代获取其中的每一个元素，<br>它是一个带状态的对象，它能在你调用 next()方法的时候返回容器中的下一个值，<br>任何实现了 __next__ 方法（python2 是 next）方法的对象都是迭代器<br>以斐波那契数列为例来实现一个迭代器：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Fib</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, n)</span>:</span></div><div class="line">        self.prev = <span class="number">0</span></div><div class="line">        self.cur = <span class="number">1</span></div><div class="line">        self.n = n</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__iter__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> self</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__next__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">if</span> self.n &gt; <span class="number">0</span>:</div><div class="line">            value = self.cur</div><div class="line">            self.cur = self.cur + self.prev</div><div class="line">            self.prev = value</div><div class="line">            self.n -= <span class="number">1</span></div><div class="line">            <span class="keyword">return</span> value</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="keyword">raise</span> StopIteration()</div><div class="line">        <span class="comment"># 兼容python2</span></div><div class="line">        <span class="function"><span class="keyword">def</span> <span class="title">__next__</span><span class="params">(self)</span>:</span></div><div class="line">            <span class="keyword">return</span> self.next()</div><div class="line"></div><div class="line">f = Fib(<span class="number">10</span>)</div><div class="line">print([i <span class="keyword">for</span> i <span class="keyword">in</span> f])</div><div class="line"><span class="comment">#[1, 1, 2, 3, 5, 8, 13, 21, 34, 55]</span></div></pre></td></tr></table></figure></p>
<p>Fib既是一个可迭代对象（因为它实现了 __iter__方法），又是一个迭代器（因为实现了 __next__方法）。<br>实例变量 prev和 cur维护迭代器内部的状态。每次调用 next()方法的时候做两件事：</p>
<ol>
<li>为下一次调用 next()方法修改状态</li>
<li>为当前这次调用生成返回结果<br>迭代器就像一个懒加载的工厂，等到有人需要的时候才给它生成值返回，没调用的时候就处于休眠状态等待下一次调用。</li>
</ol>
<h3 id="生成器"><a href="#生成器" class="headerlink" title="生成器"></a>生成器</h3><p>普通函数用 return 返回一个值，然而在 Python 中还有一种函数，用关键字 yield 来返回值，这种函数叫生成器函数，<br>函数被调用时会返回一个生成器对象，生成器本质上还是一个迭代器，也是用在迭代操作中，因此它有和迭代器一样的特性，唯一的区别在于实现方式上不一样.<br>生成器其实是一种特殊的迭代器，不过这种迭代器更加优雅。它不需要再像上面的类一样写 __iter__()和 __next__()方法了，只需要一个 yiled关键字。<br>生成器一定是迭代器（反之不成立），因此任何生成器也是以一种懒加载的模式生成值。<br>最简单的生成器函数：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">(n)</span>:</span></div><div class="line">	<span class="keyword">yield</span> n*<span class="number">2</span></div><div class="line"></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>func</div><div class="line">&lt;function func at <span class="number">0x02397B70</span>&gt;</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>g = func(<span class="number">5</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>g</div><div class="line">&lt;generator object func at <span class="number">0x023961E8</span>&gt;</div></pre></td></tr></table></figure></p>
<p>func 就是一个生成器函数，调用该函数时返回对象就是生成器 g ，这个生成器对象的行为和迭代器是非常相似的，可以用在 for 循环等场景中。<br>注意 yield 对应的值在函数被调用时不会立刻返回，而是调用next方法时（本质上 for 循环也是调用 next 方法）才返回.<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>g = func(<span class="number">5</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>next(g)</div><div class="line"><span class="number">10</span></div><div class="line"></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>g = func(<span class="number">5</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> i <span class="keyword">in</span> g:</div><div class="line"><span class="meta">... </span>    print(i)</div><div class="line">...</div><div class="line"><span class="number">10</span></div></pre></td></tr></table></figure></p>
<p>用生成器实现斐波那契数列:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">fib</span><span class="params">(n)</span>:</span></div><div class="line">    prev, curr = <span class="number">0</span>, <span class="number">1</span></div><div class="line">    <span class="keyword">while</span> n &gt; <span class="number">0</span>:</div><div class="line">        n -= <span class="number">1</span></div><div class="line">        <span class="keyword">yield</span> curr</div><div class="line">        prev, curr = curr, curr + prev</div><div class="line"></div><div class="line">print([i <span class="keyword">for</span> i <span class="keyword">in</span> fib(<span class="number">10</span>)])</div><div class="line"><span class="comment">#[1, 1, 2, 3, 5, 8, 13, 21, 34, 55]</span></div></pre></td></tr></table></figure></p>
<p>fib就是一个普通的python函数，它特殊的地方在于函数体中没有return关键字，函数的返回值是一个生成器对象。<br>当执行 f=fib()返回的是一个生成器对象，此时函数体中的代码并不会执行，只有显示或隐示地调用next的时候才会真正执行里面的代码。</p>
<p>生成器在Python中是一个非常强大的编程结构，可以用更少地中间变量写流式代码，<br>此外，相比其它容器对象它更能节省内存和CPU，当然它可以用更少的代码来实现相似的功能。现在就可以动手重构你的代码了，但凡看到类似：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">something</span><span class="params">()</span>:</span></div><div class="line">    result = []</div><div class="line">    <span class="keyword">for</span> ... <span class="keyword">in</span> ...:</div><div class="line">        result.append(x)</div><div class="line">    <span class="keyword">return</span> result</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">iter_something</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">for</span> ... <span class="keyword">in</span> ...:</div><div class="line">        <span class="keyword">yield</span> x</div></pre></td></tr></table></figure></p>
<h3 id="生成器表达式-generator-expression"><a href="#生成器表达式-generator-expression" class="headerlink" title="生成器表达式(generator expression)"></a>生成器表达式(generator expression)</h3><p>生成器表达式是列表推倒式的生成器版本，看起来像列表推导式，但是它返回的是一个生成器对象而不是列表对象。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>a = (x*x <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">10</span>))</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>a</div><div class="line">&lt;generator object &lt;genexpr&gt; at <span class="number">0x401f08</span>&gt;</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>sum(a)</div><div class="line"><span class="number">285</span></div></pre></td></tr></table></figure></p>
<h3 id="生成器的执行顺序"><a href="#生成器的执行顺序" class="headerlink" title="生成器的执行顺序"></a>生成器的执行顺序</h3><p>在调用__next__()或者进入for循环之后，函数执行到yield就返回一个值，然后函数暂停。在下次调用__next__()之后，生成器开始执行yield之后的语句。</p>
<h3 id="生成器对象的成员函数"><a href="#生成器对象的成员函数" class="headerlink" title="生成器对象的成员函数"></a>生成器对象的成员函数</h3><p>生成器对象有几个比较重要的成员函数：<br>__next__()和__iter__()：有这两个函数，生成器就具有了可迭代性<br>send()：这个函数很有用，可以用来给生成器函数传递一个新的值<br>close()：关闭这个生成器，关闭之后生成器就不可再调用<br>throw（）：给生成器传入一个异常</p>
<h3 id="send函数的用法"><a href="#send函数的用法" class="headerlink" title="send函数的用法"></a>send函数的用法</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#send函数的用法</span></div><div class="line"><span class="keyword">from</span> random <span class="keyword">import</span> randint</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">Gen</span><span class="params">(n)</span>:</span></div><div class="line">    i=<span class="number">0</span> </div><div class="line">    <span class="keyword">while</span> (i&lt;n):</div><div class="line">        i=i+<span class="number">1</span></div><div class="line">        <span class="comment">#yeild语句，在重新开始执行的时候可以获得一个值，这个值就是由send函数输入的</span></div><div class="line">        res = <span class="keyword">yield</span> randint(<span class="number">0</span>, <span class="number">100</span>)</div><div class="line">        <span class="keyword">if</span> res==<span class="string">'stop'</span>:</div><div class="line">            <span class="keyword">print</span> (<span class="string">'forced stop'</span>)</div><div class="line">            <span class="keyword">break</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__==<span class="string">'__main__'</span>:</div><div class="line">    <span class="comment">#初始化一个生成器对象</span></div><div class="line">    c=Gen(<span class="number">10</span>)</div><div class="line">    <span class="keyword">print</span> (c.__next__())</div><div class="line">    <span class="keyword">print</span> (c.__next__())</div><div class="line">    <span class="comment">#传入‘start’字符串，</span></div><div class="line">    <span class="keyword">print</span> (c.send(<span class="string">'start'</span>))</div><div class="line">    <span class="comment">#传入‘stop’字符串，生成器跳出while循环</span></div><div class="line">    <span class="keyword">print</span> (c.send(<span class="string">'stop'</span>))</div><div class="line">    <span class="comment">#继续迭代生成器将报错</span></div><div class="line">    <span class="keyword">print</span> (c.__next__())</div><div class="line"></div><div class="line">执行结果：</div><div class="line"><span class="number">95</span></div><div class="line"><span class="number">77</span></div><div class="line"><span class="number">49</span></div><div class="line">forced stop</div><div class="line">Traceback (most recent call last):</div><div class="line">  File <span class="string">"sample3.py"</span>, line <span class="number">17</span>, <span class="keyword">in</span> &lt;module&gt;</div><div class="line">    <span class="keyword">print</span> (c.send(<span class="string">'stop'</span>))</div><div class="line">StopIteration</div></pre></td></tr></table></figure>
<p>从执行结果来看，<br>调用前两个next和第三个send函数，生成器都会yield出结果。<br>第四次调用send函数之后，也开始了迭代，不过由于退出了while循环，没有再一次回到yield，所以最终的结果里面只有三个数字<br>最后一次调用next函数，出现报错，因为生成器已经关闭。</p>
<h3 id="close函数的用法"><a href="#close函数的用法" class="headerlink" title="close函数的用法"></a>close函数的用法</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#close函数的用法</span></div><div class="line"><span class="keyword">from</span> random <span class="keyword">import</span> randint</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">Gen</span><span class="params">(n)</span>:</span></div><div class="line">    i=<span class="number">0</span> </div><div class="line">    <span class="keyword">while</span> (i&lt;n):</div><div class="line">        i=i+<span class="number">1</span></div><div class="line">        <span class="keyword">yield</span> randint(<span class="number">0</span>,<span class="number">100</span>)</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__==<span class="string">'__main__'</span>:</div><div class="line">    c=Gen(<span class="number">10</span>)</div><div class="line">    <span class="keyword">print</span> (c.__next__())</div><div class="line">    <span class="keyword">print</span> (c.__next__())</div><div class="line">    <span class="comment">#close生成器之后，再调用next将报错</span></div><div class="line">    c.close()</div><div class="line">    <span class="keyword">print</span> (c.__next__())</div><div class="line"></div><div class="line">执行结果：</div><div class="line"><span class="number">81</span></div><div class="line"><span class="number">65</span></div><div class="line">Traceback (most recent call last):</div><div class="line">  File <span class="string">"sample4.py"</span>, line <span class="number">15</span>, <span class="keyword">in</span> &lt;module&gt;</div><div class="line">    <span class="keyword">print</span> (c.__next__())</div><div class="line">StopIteration</div></pre></td></tr></table></figure>
<p>close函数的用法就是关闭生成器对象，其实调用send或者next函数都会‘open’这个生成器，期间生成器都会记录执行的中间结果，直到生成器被关闭为止</p>
<h3 id="throw函数的用法"><a href="#throw函数的用法" class="headerlink" title="throw函数的用法"></a>throw函数的用法</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> random <span class="keyword">import</span> randint</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">Gen</span><span class="params">(n)</span>:</span></div><div class="line">    i=<span class="number">0</span> </div><div class="line">    <span class="keyword">while</span> (i&lt;n):</div><div class="line">        i=i+<span class="number">1</span></div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            res = <span class="keyword">yield</span> randint(<span class="number">0</span>,<span class="number">100</span>)</div><div class="line">        <span class="keyword">except</span> IOError:</div><div class="line">            <span class="keyword">print</span> (<span class="string">'get the IO Error'</span>)</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__==<span class="string">'__main__'</span>:</div><div class="line">    c=Gen(<span class="number">10</span>)</div><div class="line">    <span class="keyword">print</span> (c.__next__())</div><div class="line">    <span class="comment">#给生成器扔进去一个异常    </span></div><div class="line">    c.throw(IOError)</div><div class="line">    <span class="keyword">print</span> (c.__next__())</div></pre></td></tr></table></figure>
<p>执行结果：<br>39<br>get the IO Error<br>19</p>
<p>可以看到生成器内部成功的捕获并处理了这个异常，并且没有阻断生成器后面的执行流程</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="https://mp.weixin.qq.com/s/baavCsOtKH0uuUGI-GPecw" target="_blank" rel="external">https://mp.weixin.qq.com/s/baavCsOtKH0uuUGI-GPecw</a></li>
<li><a href="http://www.jianshu.com/p/1c7c6ee38392" target="_blank" rel="external">http://www.jianshu.com/p/1c7c6ee38392</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/18/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/18/">18</a><span class="page-number current">19</span><a class="page-number" href="/page/20/">20</a><span class="space">&hellip;</span><a class="page-number" href="/page/29/">29</a><a class="extend next" rel="next" href="/page/20/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Arvin</p>
              <p class="site-description motion-element" itemprop="description">Learn and live.</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">141</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">5</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">33</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Arvin</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  












  





  

  

  
  

  

  

  

</body>
</html>
