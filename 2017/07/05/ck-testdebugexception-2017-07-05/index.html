<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Learn and live."><title>cookbook之测试,调试和异常 | Simple &amp; Freedom</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">cookbook之测试,调试和异常</h1><a id="logo" href="/.">Simple &amp; Freedom</a><p class="description">Learn and live.</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/404.html"><i class="fa fa-heartbeat"> 公益404</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">cookbook之测试,调试和异常</h1><div class="post-meta">Jul 5, 2017<span> | </span><span class="category"><a href="/categories/python/">python</a></span></div><div class="post-content"><h3 id="在单元测试中给对象打补丁"><a href="#在单元测试中给对象打补丁" class="headerlink" title="在单元测试中给对象打补丁"></a>在单元测试中给对象打补丁</h3><p>写的单元测试中需要给指定的对象打补丁，用来断言它们在测试中的期望行为（比如，断言被调用时的参数个数，访问指定的属性等）<br>unittest.mock.patch() 函数可被用来解决这个问题。 patch() 还可被用作一个装饰器、上下文管理器或单独使用，尽管并不常见。</p>
<h3 id="将测试输出用日志记录到文件中"><a href="#将测试输出用日志记录到文件中" class="headerlink" title="将测试输出用日志记录到文件中"></a>将测试输出用日志记录到文件中</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> unittest</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyTest</span><span class="params">(unittest.TestCase)</span>:</span></div><div class="line">    <span class="keyword">pass</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    unittest.main()</div></pre></td></tr></table></figure>
<p>这样的话测试文件就是可执行的，并且会将运行测试的结果打印到标准输出上。如果你想重定向输出，就需要像下面这样修改 main() 函数：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> sys</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(out=sys.stderr, verbosity=<span class="number">2</span>)</span>:</span></div><div class="line">    loader = unittest.TestLoader()</div><div class="line">    suite = loader.loadTestsFromModule(sys.modules[__name__])</div><div class="line">    unittest.TextTestRunner(out,verbosity=verbosity).run(suite)</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    <span class="keyword">with</span> open(<span class="string">'testing.out'</span>, <span class="string">'w'</span>) <span class="keyword">as</span> f:</div><div class="line">        main(f)</div></pre></td></tr></table></figure></p>
<h3 id="忽略或期望测试失败"><a href="#忽略或期望测试失败" class="headerlink" title="忽略或期望测试失败"></a>忽略或期望测试失败</h3><p>在单元测试中忽略或标记某些测试会按照预期运行失败。unittest 模块有装饰器可用来控制对指定测试方法的处理<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> unittest</div><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">import</span> platform</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tests</span><span class="params">(unittest.TestCase)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_0</span><span class="params">(self)</span>:</span></div><div class="line">        self.assertTrue(<span class="keyword">True</span>)</div><div class="line"></div><div class="line"><span class="meta">    @unittest.skip('skipped test')</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_1</span><span class="params">(self)</span>:</span></div><div class="line">        self.fail(<span class="string">'should have failed!'</span>)</div><div class="line"></div><div class="line"><span class="meta">    @unittest.skipIf(os.name=='posix', 'Not supported on Unix')</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_2</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">import</span> winreg</div><div class="line"></div><div class="line"><span class="meta">    @unittest.skipUnless(platform.system() == 'Darwin', 'Mac specific test')</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_3</span><span class="params">(self)</span>:</span></div><div class="line">        self.assertTrue(<span class="keyword">True</span>)</div><div class="line"></div><div class="line"><span class="meta">    @unittest.expectedFailure</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_4</span><span class="params">(self)</span>:</span></div><div class="line">        self.assertEqual(<span class="number">2</span>+<span class="number">2</span>, <span class="number">5</span>)</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    unittest.main()</div></pre></td></tr></table></figure></p>
<p>kip() 装饰器能被用来忽略某个你不想运行的测试。 skipIf() 和 skipUnless()对于你只想在某个特定平台或 Python 版本或其他依赖成立时才运行测试的<br>时候非常有用。使用 @expected 的失败装饰器来标记那些确定会失败的测试，并且对这些测试你不想让测试框架打印更多信息。</p>
<h3 id="处理多个异常"><a href="#处理多个异常" class="headerlink" title="处理多个异常"></a>处理多个异常</h3><p>有一个代码片段可能会抛出多个不同的异常,可以用单个代码块处理不同的异常，可以将它们放入一个元组中<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span>:</div><div class="line">    client_obj.get_url(url)</div><div class="line"><span class="keyword">except</span> (URLError, ValueError, SocketTimeout):</div><div class="line">    client_obj.remove_url(url)</div></pre></td></tr></table></figure></p>
<p>如果你想对其中某个异常进行不同的处理，可以将其放入另外一个 except 语句中：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span>:</div><div class="line">    client_obj.get_url(url)</div><div class="line"><span class="keyword">except</span> (URLError, ValueError):</div><div class="line">    client_obj.remove_url(url)</div><div class="line"><span class="keyword">except</span> SocketTimeout:</div><div class="line">    client_obj.handle_url_timeout(url)</div></pre></td></tr></table></figure></p>
<p>很多的异常会有层级关系，对于这种情况，你可能使用它们的一个基类来捕获所有的异常。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span>:</div><div class="line">    f = open(filename)</div><div class="line"><span class="keyword">except</span> (FileNotFoundError, PermissionError):</div><div class="line">    <span class="keyword">pass</span></div><div class="line"></div><div class="line"><span class="comment"># 用基类来捕获所有的异常</span></div><div class="line"><span class="keyword">try</span>:</div><div class="line">    f = open(filename)</div><div class="line"><span class="keyword">except</span> OSError:</div><div class="line">    <span class="keyword">pass</span></div><div class="line">```    </div><div class="line"></div><div class="line">使用 <span class="keyword">as</span> 关键字来获得被抛出异常的引用</div><div class="line">```python</div><div class="line"><span class="keyword">try</span>:</div><div class="line">    f = open(filename)</div><div class="line"><span class="keyword">except</span> OSError <span class="keyword">as</span> e:</div><div class="line">    <span class="keyword">if</span> e.errno == errno.ENOENT:</div><div class="line">        logger.error(<span class="string">'File not found'</span>)</div><div class="line">    <span class="keyword">elif</span> e.errno == errno.EACCES:</div><div class="line">        logger.error(<span class="string">'Permission denied'</span>)</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        logger.error(<span class="string">'Unexpected error: %d'</span>, e.errno)</div></pre></td></tr></table></figure></p>
<h3 id="捕获所有异常"><a href="#捕获所有异常" class="headerlink" title="捕获所有异常"></a>捕获所有异常</h3><p>捕获所有的异常，可以直接捕获 Exception 即可, 这个将会捕获除了 SystemExit 、 KeyboardInterrupt 和 GeneratorExit 之外的<br>所有异常。如果你还想捕获这三个异常，将 Exception 改成 BaseException 即可.<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span>:</div><div class="line">    ...</div><div class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</div><div class="line">    ...</div><div class="line">    log(<span class="string">'Reason:'</span>, e) <span class="comment"># Important!</span></div></pre></td></tr></table></figure></p>
<h3 id="捕获异常后抛出另外的异常"><a href="#捕获异常后抛出另外的异常" class="headerlink" title="捕获异常后抛出另外的异常"></a>捕获异常后抛出另外的异常</h3><p>链接异常，使用 raise from 语句来代替简单的 raise 语句, 同时保留两个异常的信息<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">example</span><span class="params">()</span>:</span></div><div class="line"><span class="meta">... </span><span class="keyword">try</span>:</div><div class="line"><span class="meta">... </span>    int(<span class="string">'N/A'</span>)</div><div class="line"><span class="meta">... </span><span class="keyword">except</span> ValueError <span class="keyword">as</span> e:</div><div class="line"><span class="meta">... </span>    <span class="keyword">raise</span> RuntimeError(<span class="string">'A parsing error occurred'</span>) <span class="keyword">from</span> e</div><div class="line">&gt;&gt;&gt;</div><div class="line">example()</div><div class="line">Traceback (most recent call last):</div><div class="line">File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">3</span>, <span class="keyword">in</span> example</div><div class="line">ValueError: invalid literal <span class="keyword">for</span> int() <span class="keyword">with</span> base <span class="number">10</span>: <span class="string">'N/A'</span></div><div class="line">Traceback (most recent call last):</div><div class="line">File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</div><div class="line">File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">5</span>, <span class="keyword">in</span> example</div><div class="line">RuntimeError: A parsing error occurred</div></pre></td></tr></table></figure></p>
<h3 id="输出警告信息"><a href="#输出警告信息" class="headerlink" title="输出警告信息"></a>输出警告信息</h3><p>在你维护软件，提示用户某些信息，但是又不需要将其上升为异常级别，那么输出警告信息就会很有用了.<br>希望程序能生成警告信息（比如废弃特性或使用问题）,可使用 warning.warn() 函数.<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> warnings</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">(x, y, logfile=None, debug=False)</span>:</span></div><div class="line">    <span class="keyword">if</span> logfile <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</div><div class="line">        warnings.warn(<span class="string">'logfile argument deprecated'</span>, DeprecationWarning)</div></pre></td></tr></table></figure></p>
<p>warn() 的参数是一个警告消息和一个警告类，警告类有如下几种：<br>UserWarning, DeprecationWarning, SyntaxWarning, RuntimeWarning, ResourceWarning, 或 Future-Warning.<br>对警告的处理取决于你如何运行解释器以及一些其他配置。例如，如果你使用 -W all 选项去运行 Python，你会得到如下的输出：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">bash % python3 -W all example.py</div><div class="line">example.py:5: DeprecationWarning: logfile argument is deprecated</div><div class="line">warnings.warn(&apos;logfile argument is deprecated&apos;, DeprecationWarning)</div></pre></td></tr></table></figure></p>
<p>通常来讲，警告会输出到标准错误上。如果你想讲警告转换为异常，可以使用 -W error 选项：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">bash % python3 -W error example.py</div><div class="line">Traceback (most recent call last):</div><div class="line">File &quot;example.py&quot;, line 10, in &lt;module&gt;</div><div class="line">func(2, 3, logfile=&apos;log.txt&apos;)</div><div class="line">File &quot;example.py&quot;, line 5, in func</div><div class="line">warnings.warn(&apos;logfile argument is deprecated&apos;, DeprecationWarning)</div><div class="line">DeprecationWarning: logfile argument is deprecated</div></pre></td></tr></table></figure></p>
<p>默认情况下，并不是所有警告消息都会出现。-W 选项能控制警告消息的输出。 -W all 会输出所有警告消息，-W ignore 忽略掉所有警告，-W error 将警告转换成异常。<br>另外一种选择，你还可以使用 warnings.simplefilter() 函数控制输出。 always 参数会让所有警告消息出现，`ignore 忽略调所有的警告，error 将警告转换成异常。<br>warnings 模块对过滤和警告消息处理提供了大量的更高级的配置选项。</p>
<h3 id="调试基本的程序崩溃错误"><a href="#调试基本的程序崩溃错误" class="headerlink" title="调试基本的程序崩溃错误"></a>调试基本的程序崩溃错误</h3><p>程序奔溃后该怎样去调试它？<br>运行 python3 -i someprogram.py 可执行简单的调试。 -i 选项可让程序结束后打开一个交互式 shell。然后你就能查看环境.<br>可以在程序奔溃后打开 Python 的调试器<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> pdb</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>pdb.pm()</div><div class="line">&gt; sample.py(<span class="number">4</span>)func()</div><div class="line">-&gt; return n + 10</div><div class="line">(Pdb) w</div><div class="line">sample.py(<span class="number">6</span>)&lt;module&gt;()</div><div class="line">-&gt; func('Hello')</div><div class="line">&gt; sample.py(<span class="number">4</span>)func()</div><div class="line">-&gt; return n + 10</div><div class="line">(Pdb) <span class="keyword">print</span> n</div><div class="line"><span class="string">'Hello'</span></div><div class="line">(Pdb) q</div><div class="line">&gt;&gt;&gt;</div></pre></td></tr></table></figure></p>
<p>代码所在的环境很难获取交互 shell（比如在某个服务器上面），通常可以捕获异常后自己打印跟踪信息<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> traceback</div><div class="line"><span class="keyword">import</span> sys</div><div class="line"><span class="keyword">try</span>:</div><div class="line">    func(arg)</div><div class="line"><span class="keyword">except</span>:</div><div class="line">    print(<span class="string">'**** AN ERROR OCCURRED ****'</span>)</div><div class="line">    traceback.print_exc(file=sys.stderr)</div></pre></td></tr></table></figure></p>
<p>要是你的程序没有奔溃，而只是产生了一些你看不懂的结果，你在感兴趣的地方插入一下 print() 语句也是个不错的选择。<br>不过，要是你打算这样做，有一些小技巧可以帮助你。首先，traceback.print stack() 函数会你程序运行到那个点的时候创建<br>一个跟踪栈。<br>另外，你还可以像下面这样使用 pdb.set trace() 在任何地方手动的启动调试器<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> pdb</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">(arg)</span>:</span></div><div class="line">    ...</div><div class="line">    pdb.set_trace()</div><div class="line">    ....</div></pre></td></tr></table></figure></p>
<h3 id="给程序做性能测试"><a href="#给程序做性能测试" class="headerlink" title="给程序做性能测试"></a>给程序做性能测试</h3><p>测试程序运行所花费的时间并做性能测试。<br>只是简单的想测试下你的程序整体花费的时间，通常使用 Unix 时间函数就行了.<br>需要一个程序各个细节的详细报告，使用 cProfile 模块.<br>通常情况是介于这两个极端之间。比如你已经知道代码运行时在少数几个函数中花费了绝大部分时间。对于这些函数的性能测试，可以使用一个简单的装饰器：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># timethis.py</span></div><div class="line"><span class="keyword">import</span> time</div><div class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">timethis</span><span class="params">(func)</span>:</span></div><div class="line"><span class="meta">    @wraps(func)</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kwargs)</span>:</span></div><div class="line">        start = time.perf_counter()</div><div class="line">        r = func(*args, **kwargs)</div><div class="line">        end = time.perf_counter()</div><div class="line">        print(<span class="string">'&#123;&#125;.&#123;&#125; : &#123;&#125;'</span>.format(func.__module__, func.__name__, end - start))</div><div class="line">        <span class="keyword">return</span> r</div><div class="line">    <span class="keyword">return</span> wrapper</div><div class="line"></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>@timethis</div><div class="line"><span class="meta">... </span><span class="function"><span class="keyword">def</span> <span class="title">countdown</span><span class="params">(n)</span>:</span></div><div class="line"><span class="meta">... </span><span class="keyword">while</span> n &gt; <span class="number">0</span>:</div><div class="line"><span class="meta">... </span>n -= <span class="number">1</span></div><div class="line">...</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>countdown(<span class="number">10000000</span>)</div><div class="line">__main__.countdown : <span class="number">0.803001880645752</span></div></pre></td></tr></table></figure></p>
<p>要测试某个代码块运行时间，你可以定义一个上下文管理器<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> contextlib <span class="keyword">import</span> contextmanager</div><div class="line"></div><div class="line"><span class="meta">@contextmanager</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">timeblock</span><span class="params">(label)</span>:</span></div><div class="line">    start = time.perf_counter()</div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        <span class="keyword">yield</span></div><div class="line">    <span class="keyword">finally</span>:</div><div class="line">        end = time.perf_counter()</div><div class="line">        print(<span class="string">'&#123;&#125; : &#123;&#125;'</span>.format(label, end - start))</div><div class="line"></div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">with</span> timeblock(<span class="string">'counting'</span>):</div><div class="line"><span class="meta">... </span>n = <span class="number">10000000</span></div><div class="line"><span class="meta">... </span><span class="keyword">while</span> n &gt; <span class="number">0</span>:</div><div class="line"><span class="meta">... </span>n -= <span class="number">1</span></div><div class="line">...</div><div class="line">counting : <span class="number">1.5551159381866455</span></div></pre></td></tr></table></figure></p>
<p>对于测试很小的代码片段运行性能，使用 timeit 模块会很方便<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> timeit <span class="keyword">import</span> timeit</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>timeit(<span class="string">'math.sqrt(2)'</span>, <span class="string">'import math'</span>)</div><div class="line"><span class="number">0.1432319980012835</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>timeit(<span class="string">'sqrt(2)'</span>, <span class="string">'from math import sqrt'</span>)</div><div class="line"><span class="number">0.10836604500218527</span></div><div class="line"></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>timeit(<span class="string">'math.sqrt(2)'</span>, <span class="string">'import math'</span>, number=<span class="number">10000000</span>)</div><div class="line"><span class="number">1.434852126003534</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>timeit(<span class="string">'sqrt(2)'</span>, <span class="string">'from math import sqrt'</span>, number=<span class="number">10000000</span>)</div><div class="line"><span class="number">1.0270336690009572</span></div></pre></td></tr></table></figure></p>
<p>timeit 会执行参数中语句 100 万次并计算运行时间。第二个参数是运行测<br>试之前配置环境。如果你想改变循环执行次数，可以设置 number 参数.</p>
<p>当执行性能测试的时候，需要注意的是你获取的结果都是近似值。<code>time.perf_counter()</code> 函数会在给定平台上获取最高精度的计时值。不过，它仍然<br>还是基于时钟时间，很多因素会影响到它的精确度，比如机器负载。如果你对于cpu执行时间更感兴趣，使用 <code>time.process_time()</code> 来代替它。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">timethis</span><span class="params">(func)</span>:</span></div><div class="line"><span class="meta">    @wraps(func)</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kwargs)</span>:</span></div><div class="line">        start = time.process_time()</div><div class="line">        r = func(*args, **kwargs)</div><div class="line">        end = time.process_time()</div><div class="line">        print(<span class="string">'&#123;&#125;.&#123;&#125; : &#123;&#125;'</span>.format(func.__module__, func.__name__, end - start))</div><div class="line">        <span class="keyword">return</span> r</div><div class="line">    <span class="keyword">return</span> wrapper</div></pre></td></tr></table></figure></p>
<h3 id="加速程序运行"><a href="#加速程序运行" class="headerlink" title="加速程序运行"></a>加速程序运行</h3><p>你的程序运行太慢，你想在不使用复杂技术比如 C 扩展或 JIT 编译器的情况下加快程序运行速度.<br>关于程序优化的第一个准则是“不要优化”，第二个准则是“不要优化那些无关紧要的部分”。<br>通常会发现你得程序在少数几个热点地方花费了大量时间</p>
<ol>
<li>使用函数<br>定义在全局范围的代码运行起来要比定义在函数中运行慢的多。这种速度差异是由于局部变量和全局变量的实现方式（使用局部变量要更快些）。因此，如果你想让程序运行更快些，只需要将脚本语句放入函数中即可,速度的差异取决于实际运行的程序，不过根据经验，使用函数带来 15-30% 的性能提升是很常见的。</li>
<li>尽可能去掉属性访问<br>每一次使用点 (.) 操作符来访问属性的时候会带来额外的开销。它会触发特定的方法，比如 <code>__getattribute__ ()</code> 和 <code>__getattr__ ()</code> ，这些方法会进行字典操作操作。<br>可以使用 from module import name 这样的导入形式，以及使用绑定的方法.<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 方式1</span></div><div class="line"><span class="keyword">import</span> math</div><div class="line">math.sqrt(n)</div><div class="line"><span class="comment"># 方式2</span></div><div class="line"><span class="keyword">from</span> math <span class="keyword">import</span> sqrt</div></pre></td></tr></table></figure>
</li>
</ol>
<p>方式2消除了属性访问,用sqrt() 代替了 math.sqrt() </p>
<ol>
<li>理解局部变量<br>局部变量会比全局变量运行速度快,在内部循环中，可以将某个需要频繁访问的属性放入到一个局部变量中.对于类中的属性访问也同样适用于这个原理。通常来讲，查找某个值比如<br>self.name 会比访问一个局部变量要慢一些。</li>
<li>避免不必要的抽象<br>任何时候当你使用额外的处理层（比如装饰器、属性访问、描述器）去包装你的代码时，都会让程序运行变慢.</li>
<li>使用内置的容器<br>内置的数据类型比如字符串、元组、列表、集合和字典都是使用 C 来实现的，运行起来非常快。如果你想自己实现新的数据结构（比如链接列表、平衡树等），那么要想在性能上达到内置的速度几乎不可能，因此，还是乖乖的使用内置的吧.</li>
<li>避免创建不必要的数据结构或复制<br>理解或信任 Python 的内存模型，不要滥用 copy.deepcopy() 之类的函数</li>
</ol>
<p>作为一般准则，不要对程序的每一个部分都去优化, 因为这些修改回导致代码难以阅读和理解。你应该专注于优化产生性能瓶颈的地方，比如内部循环。<br>引用John Ousterhout 说过的话：“最好的性能优化时从不工作到工作状态的迁移”。直到你真的需要优化的时候再去考虑它。确保你程序正确的运行通常比让它运行更快要更重要一些（至少开始是这样的）.</p>
</div><div class="tags"><a href="/tags/python/">python</a></div><div class="post-nav"><a href="/2017/07/06/ck-CExtends-2017-07-06/" class="pre">cookbook之C 语言扩展</a><a href="/2017/07/05/ck-sysmanager-2017-07-05/" class="next">cookbook之脚本编程与系统管理</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Web/">Web</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/js/">js</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/node/">node</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/vue/">vue</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/web/">web</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/工具/">工具</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/思想/">思想</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据库/">数据库</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/编程/">编程</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/随笔/">随笔</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/方法/" style="font-size: 15px;">方法</a> <a href="/tags/算法/" style="font-size: 15px;">算法</a> <a href="/tags/node/" style="font-size: 15px;">node</a> <a href="/tags/计算机基础/" style="font-size: 15px;">计算机基础</a> <a href="/tags/谷歌/" style="font-size: 15px;">谷歌</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/C-C/" style="font-size: 15px;">C/C++</a> <a href="/tags/OOP/" style="font-size: 15px;">OOP</a> <a href="/tags/css/" style="font-size: 15px;">css</a> <a href="/tags/设计模式/" style="font-size: 15px;">设计模式</a> <a href="/tags/flask/" style="font-size: 15px;">flask</a> <a href="/tags/Git/" style="font-size: 15px;">Git</a> <a href="/tags/Hexo/" style="font-size: 15px;">Hexo</a> <a href="/tags/http/" style="font-size: 15px;">http</a> <a href="/tags/js/" style="font-size: 15px;">js</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/Markdown/" style="font-size: 15px;">Markdown</a> <a href="/tags/MongoDB/" style="font-size: 15px;">MongoDB</a> <a href="/tags/MySQL/" style="font-size: 15px;">MySQL</a> <a href="/tags/web/" style="font-size: 15px;">web</a> <a href="/tags/NSIS/" style="font-size: 15px;">NSIS</a> <a href="/tags/scrapy/" style="font-size: 15px;">scrapy</a> <a href="/tags/PyQt5/" style="font-size: 15px;">PyQt5</a> <a href="/tags/redis/" style="font-size: 15px;">redis</a> <a href="/tags/RegExp/" style="font-size: 15px;">RegExp</a> <a href="/tags/Tools/" style="font-size: 15px;">Tools</a> <a href="/tags/爬虫/" style="font-size: 15px;">爬虫</a> <a href="/tags/SVN/" style="font-size: 15px;">SVN</a> <a href="/tags/tornado/" style="font-size: 15px;">tornado</a> <a href="/tags/vue/" style="font-size: 15px;">vue</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/02/01/spiderallsite-2018-02-01/">全站爬虫</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/25/linux-crontab-2018-01-25/">linux之crontab使用</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/16/py-scrapy2-2018-01-16/">scrapy笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/15/py-scrapy1-2018-01-15/">scrapy笔记-安装</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/15/py-pipcmds-2018-01-15/">python之pip常用命令</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/11/css-note1-2018-01-11/">css笔记1</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/11/selenium-phatomjs-2017-12-11/">selenium-phatomjs使用</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/08/jQuery-notes1-2017-12-08/">jQuery笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/08/js-dom-2017-12-08/">javascript之DOM操作</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/08/appium-notes1-2017-12-08/">Appium笔记</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">Simple &amp; Freedom.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.css"><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>