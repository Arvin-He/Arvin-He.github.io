<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="Simple & Freedom" type="application/atom+xml" />






<meta name="description" content="Learn and live.">
<meta property="og:type" content="website">
<meta property="og:title" content="Simple &amp; Freedom">
<meta property="og:url" content="http://arvin-he.github.io/page/18/index.html">
<meta property="og:site_name" content="Simple &amp; Freedom">
<meta property="og:description" content="Learn and live.">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Simple &amp; Freedom">
<meta name="twitter:description" content="Learn and live.">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://arvin-he.github.io/page/18/"/>





  <title>Simple & Freedom</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Simple & Freedom</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Learn and live.</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            公益404
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://arvin-he.github.io/2017/06/01/python-lambda-2017-06-01/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Arvin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Simple & Freedom">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/06/01/python-lambda-2017-06-01/" itemprop="url">Python之Lambda使用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-01T10:21:48+08:00">
                2017-06-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Lambda-函数"><a href="#Lambda-函数" class="headerlink" title="Lambda 函数"></a>Lambda 函数</h3><p>Python 中定义函数有两种方法，一种是用常规方式 def 定义，函数要指定名字，第二种是用 lambda 定义，不需要指定名字，称为 Lambda 函数。<br>Lambda 函数又称匿名函数，匿名函数就是没有名字的函数。有些函数如果只是临时一用，而且它的业务逻辑也很简单时，就没必要非给它取个名字不可。</p>
<h3 id="lamdba-函数使用场景"><a href="#lamdba-函数使用场景" class="headerlink" title="lamdba 函数使用场景"></a>lamdba 函数使用场景</h3><ol>
<li>函数式编程<br>Python提供了函数式编程的特性，如 map、reduce、filter、sorted 这些函数都支持函数作为参数.<br>lambda 函数就可以应用在函数式编程中。下面看一个例子: 将一个整数列表，要求按照列表中元素的绝对值大小升序排列<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 方法1</span></div><div class="line">In [<span class="number">12</span>]: my_list = [<span class="number">2</span>, <span class="number">6</span>, <span class="number">5</span>, <span class="number">-3</span>, <span class="number">-1</span>, <span class="number">8</span>]           </div><div class="line">                                                  </div><div class="line">In [<span class="number">13</span>]: sorted(my_list, key=<span class="keyword">lambda</span> x : abs(x))   </div><div class="line">Out[<span class="number">13</span>]: [<span class="number">-1</span>, <span class="number">2</span>, <span class="number">-3</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">8</span>]                     </div><div class="line"></div><div class="line"><span class="comment"># 方法2                                              </span></div><div class="line">In [<span class="number">14</span>]: <span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">(x)</span>:</span>                              </div><div class="line">    ...:     <span class="keyword">return</span> abs(x)                        </div><div class="line">    ...:                                          </div><div class="line">                                                  </div><div class="line">In [<span class="number">15</span>]: sorted(my_list, key=foo)                 </div><div class="line">Out[<span class="number">15</span>]: [<span class="number">-1</span>, <span class="number">2</span>, <span class="number">-3</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">8</span>]</div></pre></td></tr></table></figure>
</li>
</ol>
<p>方法1和方法2都能达到同样的效果,只不过方法2看起来不够 Pythonic 而已。方法1更加简洁</p>
<ol>
<li>闭包<br>看一个用 lambda 函数作为闭包的例子<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">my_add</span><span class="params">(n)</span>:</span></div><div class="line"><span class="meta">... </span>    <span class="keyword">return</span> <span class="keyword">lambda</span> x:x+n</div><div class="line">...</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>add_3 = my_add(<span class="number">3</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>add_3(<span class="number">7</span>)</div><div class="line"><span class="number">10</span></div><div class="line"></div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">my_add</span><span class="params">(n)</span>:</span></div><div class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(x)</span>:</span></div><div class="line"><span class="meta">... </span>        <span class="keyword">return</span> x+n</div><div class="line"><span class="meta">... </span>    <span class="keyword">return</span> wrapper</div><div class="line">...</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>add_5 = my_add(<span class="number">5</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>add_5(<span class="number">2</span>)</div><div class="line"><span class="number">7</span></div></pre></td></tr></table></figure>
</li>
</ol>
<p>这里的 lambda 函数就是一个闭包，在全局作用域范围中，<code>add_3(7)</code> 可以正常执行且返回值为10，之所以返回10是因为在<code>my_add</code> 局部作用域中，变量 n 的值在闭包的作用使得它在全局作用域也可以被访问到。换成常规函数也可以实现闭包，只不过是这种方式稍显啰嗦。</p>
<h3 id="使用lambda局限与注意点"><a href="#使用lambda局限与注意点" class="headerlink" title="使用lambda局限与注意点"></a>使用lambda局限与注意点</h3><ol>
<li>python中的lambda中不可以赋值</li>
<li>python中的lambda只能写一句表达式,不可以写多个语句</li>
<li>如果用 lambda 函数不能使你的代码变得更清晰时，这时就要考虑使用常规的方式来定义函数, zen of python 中有这样一句话是 Explicit is better than implicit(明了胜于晦涩)</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://arvin-he.github.io/2017/06/01/python-closure-2017-06-01/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Arvin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Simple & Freedom">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/06/01/python-closure-2017-06-01/" itemprop="url">Python之闭包</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-01T08:31:07+08:00">
                2017-06-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>谈到闭包,先要了解两个概念:作用域和嵌套函数<br>Python 里面有四种作用域：function, module, global和 class 作用域。由于 Python 不区分变量的声明，所以在第一次初始化变量时（必须为赋值操作）将变量加入当前环境中。如果在没对变量进行初始化的情况下使用该变量就会报运行时异常，但如果仅仅是访问（并不赋值）的情况下，查找变量的顺序会按照 LEGB 规则 (Local, Enclosing, Global, Built-in)。</p>
<h3 id="作用域"><a href="#作用域" class="headerlink" title="作用域"></a>作用域</h3><p>作用域是程序运行时变量可被访问的范围，定义在函数内的变量是局部变量，局部变量的作用范围只能是函数内部范围内，它不能在函数外引用。<br>定义在模块最外层的变量是全局变量，它是全局范围内可见的，当然在函数里面也可以读取到全局变量的</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">s = <span class="string">"hello"</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">()</span>:</span></div><div class="line">    s += <span class="string">"world"</span></div><div class="line">    <span class="keyword">return</span> s</div><div class="line"></div><div class="line">foo()  <span class="comment"># UnboundLocalError: local variable 's' referenced before assignment</span></div></pre></td></tr></table></figure>
<p>由于在函数 foo 中在没有对 s 初始化的情况下使用了该值，所以这里会报异常，解决的办法就是使用 global 关键字：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">s = <span class="string">"hello"</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">global</span> s</div><div class="line">    s += <span class="string">" world"</span></div><div class="line">    <span class="keyword">return</span> s</div><div class="line">foo()  <span class="comment"># return "hello world"</span></div></pre></td></tr></table></figure></p>
<p>但由于 global 关键字只能限定在global作用域内查找变量，在有嵌套定义的时候就有问题了，比如：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">()</span>:</span></div><div class="line">    s = <span class="string">"hello"</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">bar</span><span class="params">()</span>:</span></div><div class="line">        <span class="keyword">global</span> s     <span class="comment"># NameError: global name 's' is not defined</span></div><div class="line">        s += <span class="string">" world"</span></div><div class="line">        <span class="keyword">return</span> s</div><div class="line">    <span class="keyword">return</span> bar</div><div class="line">foo()()</div></pre></td></tr></table></figure></p>
<p>Python 3 中引入了 nonlocal 关键字来解决这个问题，：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">()</span>:</span></div><div class="line">    s = <span class="string">"hello"</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">bar</span><span class="params">()</span>:</span></div><div class="line">        <span class="keyword">nonlocal</span> s</div><div class="line">        s += <span class="string">" world"</span></div><div class="line">        <span class="keyword">return</span> s</div><div class="line">    <span class="keyword">return</span> bar</div><div class="line">foo()()   <span class="comment"># return "hello world"</span></div></pre></td></tr></table></figure></p>
<h3 id="嵌套函数"><a href="#嵌套函数" class="headerlink" title="嵌套函数"></a>嵌套函数</h3><p>函数不仅可以定义在模块的最外层，还可以定义在另外一个函数的内部，像这种定义在函数里面的函数称之为嵌套函数（nested function）例如：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_msg</span><span class="params">()</span>:</span></div><div class="line">    <span class="comment"># print_msg 是外围函数</span></div><div class="line">    msg = <span class="string">"zen of python"</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">printer</span><span class="params">()</span>:</span></div><div class="line">        <span class="comment"># printer是嵌套函数</span></div><div class="line">        print(msg)</div><div class="line">    printer()</div><div class="line"><span class="comment"># 输出 zen of python</span></div><div class="line">print_msg()</div></pre></td></tr></table></figure></p>
<p>对于嵌套函数，它可以访问到其外层作用域中声明的非局部（non-local）变量，比如代码示例中的变量 msg 可以被嵌套函数 printer 正常访问。<br>那么有没有一种可能即使脱离了函数本身的作用范围，局部变量还可以被访问得到呢？答案是闭包</p>
<h3 id="闭包"><a href="#闭包" class="headerlink" title="闭包"></a>闭包</h3><p>简单的说:闭包是一个函数内部嵌套着另一个函数，而被嵌套的那个函数有权利访问嵌套它的那个函数的作用域中变量。</p>
<p>当符合下面几个条件时就形成了闭包：</p>
<ul>
<li>有一个Nested function</li>
<li>这个Nested function访问了父函数作用域中的变量</li>
<li>父函数返回了这个Nested function</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_msg</span><span class="params">()</span>:</span></div><div class="line">    <span class="comment"># print_msg 是外围函数</span></div><div class="line">    msg = <span class="string">"zen of python"</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">printer</span><span class="params">()</span>:</span></div><div class="line">        <span class="comment"># printer 是嵌套函数</span></div><div class="line">        print(msg)</div><div class="line">    <span class="keyword">return</span> printer</div><div class="line"></div><div class="line">another = print_msg()</div><div class="line"><span class="comment"># 输出 zen of python</span></div><div class="line">another()</div></pre></td></tr></table></figure>
<p>这段代码和上面的嵌套函数的效果一样，都输出 “zen of python”。不同的地方在于内部函数 printer 直接作为返回值返回了。<br>一般情况下，函数中的局部变量仅在函数的执行期间可用，一旦 <code>print_msg()</code> 执行过后，我们会认为 msg变量将不再可用。<br>然而，在这里我们发现 print_msg 执行完之后，在调用 another 的时候 msg 变量的值正常输出了，这就是闭包的作用，闭包使得局部变量在函数外被访问成为可能。这里的 another 就是一个闭包，闭包本质上是一个函数，它有两部分组成，printer 函数和变量 msg。闭包使得这些变量的值始终保存在内存中。<br>闭包，顾名思义，就是一个封闭的包裹，里面包裹着自由变量，就像在类里面定义的属性值一样，自由变量的可见范围随同包裹，哪里可以访问到这个包裹，哪里就可以访问到这个自由变量.</p>
<h3 id="为什么要使用闭包"><a href="#为什么要使用闭包" class="headerlink" title="为什么要使用闭包"></a>为什么要使用闭包</h3><p>运用闭包可以避免对全局变量的使用。对于一个只有需要实现少数方法的类我们也可以用闭包来替代，这样做可以减少资源的使用。<br>此外，闭包允许将函数与其所操作的某些数据（环境）关连起来。这一点与面向对象编程是非常类似的，在面对象编程中，对象允许我们将某些数据（对象的属性）与一个或者多个方法相关联。一般来说，当对象中只有一个方法时，这时使用闭包是更好的选择。来看一个例子：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">5</span>]: <span class="function"><span class="keyword">def</span> <span class="title">adder</span><span class="params">(x)</span>:</span>                        </div><div class="line">   ...:     <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(y)</span>:</span>                  </div><div class="line">   ...:         print(<span class="string">"x = &#123;&#125;"</span>.format(x))    </div><div class="line">   ...:         print(<span class="string">"y = &#123;&#125;"</span>.format(y))    </div><div class="line">   ...:         <span class="keyword">return</span> x+y                   </div><div class="line">   ...:     <span class="keyword">return</span> wrapper                   </div><div class="line">   ...:                                      </div><div class="line">   ...:                                      </div><div class="line">                                             </div><div class="line">In [<span class="number">6</span>]: adder5 = adder(<span class="number">5</span>)                    </div><div class="line">                                             </div><div class="line">In [<span class="number">7</span>]: adder5(<span class="number">10</span>)                           </div><div class="line">x = <span class="number">5</span>                                        </div><div class="line">y = <span class="number">10</span>                                       </div><div class="line">Out[<span class="number">7</span>]: <span class="number">15</span>                                   </div><div class="line">                                             </div><div class="line">In [<span class="number">8</span>]: adder5(<span class="number">6</span>)                            </div><div class="line">x = <span class="number">5</span>                                        </div><div class="line">y = <span class="number">6</span>                                        </div><div class="line">Out[<span class="number">8</span>]: <span class="number">11</span></div></pre></td></tr></table></figure></p>
<p>这比用类来实现更优雅，此外装饰器也是基于闭包的一中应用场景。<br>所有函数都有一个 <code>__closure__</code>属性，如果这个函数是一个闭包的话，那么它返回的是一个由 cell 对象 组成的元组对象。cell 对象的<code>cell_contents</code> 属性就是闭包中的自由变量。这解释了为什么局部变量脱离函数之后，还可以在函数之外被访问的原因的，因为它存储在了闭包的 <code>cell_contents</code>中了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">9</span>]: adder.__closure__</div><div class="line"></div><div class="line">In [<span class="number">10</span>]: adder5.__closure__</div><div class="line">Out[<span class="number">10</span>]: (&lt;cell at <span class="number">0x03F8FB30</span>: int object at <span class="number">0x1DFAD210</span>&gt;,)</div><div class="line"></div><div class="line">In [<span class="number">11</span>]: adder5.__closure__[<span class="number">0</span>].cell_contents</div><div class="line">Out[<span class="number">11</span>]: <span class="number">5</span></div></pre></td></tr></table></figure>
<h3 id="闭包与装饰器"><a href="#闭包与装饰器" class="headerlink" title="闭包与装饰器"></a>闭包与装饰器</h3><p>闭包通常用来实现一个通用的功能，Python中的装饰器就是对闭包的一种应用，只不过装饰器中父函数的参数是一个函数<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_wrap</span><span class="params">(func)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args)</span>:</span></div><div class="line">        print(<span class="string">"before function"</span>)</div><div class="line">        func(*args)</div><div class="line">        print(<span class="string">"after function"</span>)</div><div class="line">    <span class="keyword">return</span> wrapper</div><div class="line">    </div><div class="line"><span class="meta">@make_wrap</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_msg</span><span class="params">(msg)</span>:</span></div><div class="line">    print(msg)</div><div class="line">    </div><div class="line"><span class="meta">&gt;&gt;&gt; </span>print_msg(<span class="string">"Hello"</span>)</div><div class="line">before function</div><div class="line">Hello</div><div class="line">after function</div></pre></td></tr></table></figure></p>
<p>装饰器也可以进行叠加<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_another</span><span class="params">(func)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args)</span>:</span></div><div class="line">        print(<span class="string">"another begin"</span>)</div><div class="line">        func(*args)</div><div class="line">        print(<span class="string">"another end"</span>)</div><div class="line">    <span class="keyword">return</span> wrapper</div><div class="line"></div><div class="line"><span class="meta">@make_another</span></div><div class="line"><span class="meta">@make_wrap</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_msg</span><span class="params">(msg)</span>:</span></div><div class="line">    print(msg)</div><div class="line"></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>print_msg(<span class="string">"Hello"</span>)</div><div class="line">another begin</div><div class="line">before function</div><div class="line">Hello</div><div class="line">after function</div><div class="line">another end</div></pre></td></tr></table></figure></p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="http://liujiacai.net/blog/2016/05/28/scope-closure/" target="_blank" rel="external">http://liujiacai.net/blog/2016/05/28/scope-closure/</a></li>
<li><a href="https://juejin.im/post/59191552128fe1005ccd015f" target="_blank" rel="external">https://juejin.im/post/59191552128fe1005ccd015f</a></li>
<li><a href="https://juejin.im/post/59022e730ce463006156fdf3" target="_blank" rel="external">https://juejin.im/post/59022e730ce463006156fdf3</a></li>
<li><a href="https://kasheemlew.github.io/2017/04/05/python-closure/" target="_blank" rel="external">https://kasheemlew.github.io/2017/04/05/python-closure/</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://arvin-he.github.io/2017/05/31/python-partial-2017-05-31/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Arvin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Simple & Freedom">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/31/python-partial-2017-05-31/" itemprop="url">Python之functools</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-31T16:57:57+08:00">
                2017-05-31
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="functools-partial"><a href="#functools-partial" class="headerlink" title="functools.partial"></a>functools.partial</h3><p>functools.partial 通过包装手法，允许我们 “重新定义” 函数签名, 用一些默认参数包装一个可调用对象, 返回结果是可调用对象，并且可以像原始对象一样对待冻结部分函数位置函数或关键字参数，简化函数, 更少更灵活的函数参数调用. 总之,通过设定参数的默认值，可以降低函数调用的难度.<br>简单总结functools.partial的作用就是，把一个函数的某些参数给固定住（也就是设置默认值），返回一个新的函数，调用这个新函数会更简单。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> functools</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(a, b)</span>:</span></div><div class="line">    <span class="keyword">return</span> a + b</div><div class="line"></div><div class="line">add(<span class="number">4</span>, <span class="number">2</span>)</div><div class="line"><span class="number">6</span></div><div class="line"></div><div class="line">plus3 = functools.partial(add, <span class="number">3</span>)</div><div class="line">plus3(<span class="number">4</span>)</div><div class="line"><span class="number">7</span></div></pre></td></tr></table></figure></p>
<h3 id="functool-update-wrapper"><a href="#functool-update-wrapper" class="headerlink" title="functool.update_wrapper"></a>functool.update_wrapper</h3><p>默认partial对象没有<code>__name__</code>和<code>__doc__</code>, 这种情况下，对于装饰器函数非常难以debug.<br>使用<code>update_wrapper()</code>,从原始对象拷贝或加入现有partial对象,它可以把被封装函数的<code>__name__</code>、 <code>__module__</code> 、<code>__doc__</code>和<code>__dict__</code>都复制到封装函数去(模块级别常量<code>WRAPPER_ASSIGNMENTS</code>, <code>WRAPPER_UPDATES</code>)<br>这个函数主要用在装饰器函数中，装饰器返回函数反射得到的是包装函数的函数定义而不是原始函数定义<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> update_wrapper</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">wrap2</span><span class="params">(func)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">call_it</span><span class="params">(*args, **kwargs)</span>:</span></div><div class="line">        <span class="string">"""wrap func: call_it2"""</span></div><div class="line">        <span class="keyword">print</span> <span class="string">'before call'</span></div><div class="line">        <span class="keyword">return</span> func(*args, **kwargs)</div><div class="line">    <span class="keyword">return</span> update_wrapper(call_it, func)</div><div class="line"></div><div class="line"><span class="meta">@wrap2</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello2</span><span class="params">()</span>:</span></div><div class="line">    <span class="string">"""test hello"""</span></div><div class="line">    <span class="keyword">print</span> <span class="string">'hello world2'</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line"></div><div class="line">    hello2()</div><div class="line">    <span class="keyword">print</span> hello2.__name__</div><div class="line">    <span class="keyword">print</span> hello2.__doc__</div><div class="line"></div><div class="line">before call</div><div class="line">hello world2</div><div class="line">hello2</div><div class="line">test hello</div></pre></td></tr></table></figure></p>
<h3 id="functool-wraps"><a href="#functool-wraps" class="headerlink" title="functool.wraps"></a>functool.wraps</h3><p>调用函数装饰器partial(update_wrapper, wrapped=wrapped, assigned=assigned, updated=updated)的简写<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">wrap3</span><span class="params">(func)</span>:</span></div><div class="line"><span class="meta">    @wraps(func)</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">call_it</span><span class="params">(*args, **kwargs)</span>:</span></div><div class="line">        <span class="string">"""wrap func: call_it2"""</span></div><div class="line">        <span class="keyword">print</span> <span class="string">'before call'</span></div><div class="line">        <span class="keyword">return</span> func(*args, **kwargs)</div><div class="line">    <span class="keyword">return</span> call_it</div><div class="line"></div><div class="line"><span class="meta">@wrap3</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello3</span><span class="params">()</span>:</span></div><div class="line">    <span class="string">"""test hello 3"""</span></div><div class="line">    <span class="keyword">print</span> <span class="string">'hello world3'</span></div><div class="line"></div><div class="line"></div><div class="line">before call</div><div class="line">hello world3</div><div class="line">hello3</div><div class="line">test hello <span class="number">3</span></div></pre></td></tr></table></figure></p>
<h3 id="functools-reduce"><a href="#functools-reduce" class="headerlink" title="functools.reduce"></a>functools.reduce</h3><p>等同于内置函数reduce(),用这个的原因是使代码更兼容(python3)</p>
<h3 id="functools-cmp-to-key"><a href="#functools-cmp-to-key" class="headerlink" title="functools.cmp_to_key"></a>functools.cmp_to_key</h3><p><code>functools.cmp_to_key(func)</code><br>将老式的比较函数（comparison function）转换为关键字函数（key function），与接受key function的工具一同使用（例如sorted，min，max，heapq.nlargest，itertools.groupby），该函数主要用于将程序转换成Python 3格式的，因为Python 3中不支持比较函数。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> cmp_to_key</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">compare</span><span class="params">(ele1,ele2)</span>:</span></div><div class="line">    <span class="keyword">return</span> ele2 - ele1</div><div class="line"></div><div class="line">a = [<span class="number">2</span>,<span class="number">3</span>,<span class="number">1</span>]</div><div class="line"><span class="keyword">print</span> sorted(a, key = cmp_to_key(compare))</div><div class="line"></div><div class="line">[<span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>]</div></pre></td></tr></table></figure></p>
<h3 id="functools-total-ordering"><a href="#functools-total-ordering" class="headerlink" title="functools.total_ordering"></a>functools.total_ordering</h3><p><code>functools.total_ordering(cls)</code>这是一个类装饰器，给定一个类，这个类定义了一个或者多个比较排序方法，这个类装饰器将会补充其余的比较方法，减少了自己定义所有比较方法时的工作量；<br>这个装饰器是在python2.7的时候加上的，它是针对某个类如果定义了<code>__lt__</code>、 le 、 gt 、<code>__ge__</code>这些方法中的至少一个，同时，被修饰的类还应该提供 <code>__eq__()</code>方法。使用该装饰器，则会自动的把其他几个比较函数也实现在该类中</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@total_ordering</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__eq__</span><span class="params">(self, other)</span>:</span></div><div class="line">        <span class="keyword">return</span> ((self.lastname.lower(), self.firstname.lower()) ==</div><div class="line">                (other.lastname.lower(), other.firstname.lower()))</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__lt__</span><span class="params">(self, other)</span>:</span></div><div class="line">        <span class="keyword">return</span> ((self.lastname.lower(), self.firstname.lower()) &lt;</div><div class="line">                (other.lastname.lower(), other.firstname.lower()))</div><div class="line"><span class="keyword">print</span> dir(Student)</div><div class="line"></div><div class="line">[<span class="string">'__doc__'</span>, <span class="string">'__eq__'</span>, <span class="string">'__ge__'</span>, <span class="string">'__gt__'</span>, <span class="string">'__le__'</span>, <span class="string">'__lt__'</span>, <span class="string">'__module__'</span>]</div></pre></td></tr></table></figure>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="http://www.tuicool.com/articles/qEjEBzy" target="_blank" rel="external">http://www.tuicool.com/articles/qEjEBzy</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://arvin-he.github.io/2017/05/28/python-flasknotes-2017-05-28/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Arvin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Simple & Freedom">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/28/python-flasknotes-2017-05-28/" itemprop="url">Flask笔记</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-28T08:43:19+08:00">
                2017-05-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Flask路由中使用正则表达式"><a href="#Flask路由中使用正则表达式" class="headerlink" title="Flask路由中使用正则表达式"></a>Flask路由中使用正则表达式</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> werkzeug.routing <span class="keyword">import</span> BaseConverter</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RegexConverter</span><span class="params">(BaseConverter)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, url_map, *item)</span>:</span></div><div class="line">        super(RegexConverter, self).__init__(url_map)</div><div class="line">        self.regex = item[<span class="number">0</span>]</div><div class="line"></div><div class="line"><span class="comment"># 把转换器在初始化时设定到url_map,转换器名称为'regex'</span></div><div class="line">app.url_map.converters[<span class="string">'regex'</span>] = RegexConverter</div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">@app.route('/user/&lt;regex("[a-z]&#123;3&#125;"):user_name&gt;')</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">user</span><span class="params">(user_name)</span>:</span></div><div class="line">    <span class="keyword">return</span> <span class="string">'User %s'</span> % user_name</div></pre></td></tr></table></figure>
<h3 id="多个url指向同一个视图"><a href="#多个url指向同一个视图" class="headerlink" title="多个url指向同一个视图"></a>多个url指向同一个视图</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@app.route('/projects/')</span></div><div class="line"><span class="meta">@app.route('/projects2/')</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">projects</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">return</span> <span class="string">'The project page'</span></div></pre></td></tr></table></figure>
<p><strong>注意:</strong>多个路由指向同一视图时,顺序是先从最外层的装饰器路由开始,一旦匹配到路由,就马上执行视图函数,下面的装饰器就不再执行了.</p>
<h3 id="使用Manager运行flask应用程序"><a href="#使用Manager运行flask应用程序" class="headerlink" title="使用Manager运行flask应用程序"></a>使用Manager运行flask应用程序</h3><h3 id="自定义模板过滤器"><a href="#自定义模板过滤器" class="headerlink" title="自定义模板过滤器"></a>自定义模板过滤器</h3><p>自定义markdown过滤器<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@app.template_fiter('md')</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">markdown_to_html</span><span class="params">(txt)</span>:</span></div><div class="line">    <span class="keyword">from</span> markdown <span class="keyword">import</span> markdown</div><div class="line">    <span class="keyword">return</span> markdown(txt)</div></pre></td></tr></table></figure></p>
<h3 id="在模版中调用python函数"><a href="#在模版中调用python函数" class="headerlink" title="在模版中调用python函数"></a>在模版中调用python函数</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@app.context_processor</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">inject_methods</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">return</span> dict(read_md=read_md)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_md</span><span class="params">(file_name)</span>:</span></div><div class="line">    <span class="keyword">with</span> open(filename) <span class="keyword">as</span> md_file:</div><div class="line">        content = reduce(<span class="keyword">lambda</span> x,y: x+y, md_file.readlines())</div><div class="line">    <span class="keyword">return</span> content.decode(<span class="string">'utf-8'</span>)</div></pre></td></tr></table></figure>
<p>过滤器和全局方法配合使得页面更加灵活</p>
<h3 id="模版继承-包含与宏"><a href="#模版继承-包含与宏" class="headerlink" title="模版继承/包含与宏"></a>模版继承/包含与宏</h3><p><hr>  画直线</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://arvin-he.github.io/2017/05/27/python-monkeypatch-2017-05-27/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Arvin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Simple & Freedom">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/27/python-monkeypatch-2017-05-27/" itemprop="url">Python之Monkeypatch</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-27T14:21:16+08:00">
                2017-05-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="猴子补丁的由来"><a href="#猴子补丁的由来" class="headerlink" title="猴子补丁的由来"></a>猴子补丁的由来</h3><p>所谓的猴子补丁的含义是指在动态语言中，不去改变源码而对功能进行追加和变更。<br>猴子补丁的这个叫法起源于Zope框架，大家在修正Zope的Bug的时候经常在程序后面追加更新部分，这些被称作是“杂牌军补丁(guerilla patch)”，后来guerilla就渐渐的写成了gorllia(猩猩)，再后来就写了monkey(猴子)，所以猴子补丁的叫法是这么莫名其妙的得来的。</p>
<h3 id="从Gevent学习猴子补丁的设计"><a href="#从Gevent学习猴子补丁的设计" class="headerlink" title="从Gevent学习猴子补丁的设计"></a>从Gevent学习猴子补丁的设计</h3><p>猴子补丁这种东西充分利用了动态语言的灵活性，可以对现有的语言Api进行追加，替换，修改Bug，甚至性能优化等等。比如gevent的猴子补丁就可以对ssl、socket、os、time、select、thread、subprocess、sys等模块的功能进行了增强和替换。</p>
<h3 id="gevent中的猴子补丁模块gevent-monkey的设计和实现"><a href="#gevent中的猴子补丁模块gevent-monkey的设计和实现" class="headerlink" title="gevent中的猴子补丁模块gevent.monkey的设计和实现"></a>gevent中的猴子补丁模块gevent.monkey的设计和实现</h3><p>如果自己要设计实现猴子补丁，可以按照这么个模式去做，可以用ipython来阅读python模块的代码，执行import gevent.monkey之后，只需要输入??gevent.monkey就可以查看源码了。</p>
<p>这个模块核心的函数其实就几个，分别是<code>get_original、patch_item、remove_item、patch_module</code>,还有一个全局变量叫做saved，默认指向一个空的字典对象。</p>
<p>首先来看patch_item函数：<br>这个函数的功能就是从指定模块中查找旧的项，并把旧的项保存到saved字典中，然后将旧项替换成新项。这里没有使用None，而是构建了一个空的object()作为默认属性.<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">patch_item</span><span class="params">(module, attr, newitem)</span>:</span></div><div class="line">    NONE = object()</div><div class="line">    olditem = getattr(module, attr, NONE)</div><div class="line">    <span class="keyword">if</span> olditem <span class="keyword">is</span> <span class="keyword">not</span> NONE:</div><div class="line">        saved.setdefault(module.__name__, &#123;&#125;).setdefault(attr, olditem)</div><div class="line">    setattr(module, attr, newitem)</div></pre></td></tr></table></figure></p>
<p>patch_module的实现:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">patch_module</span><span class="params">(name, items=None)</span>:</span></div><div class="line">	gevent_module = getattr(__import__(<span class="string">'gevent.'</span> + name), name)</div><div class="line">	module_name = getattr(gevent_module, <span class="string">'__target__'</span>, name)</div><div class="line">	module = __import__(module_name)</div><div class="line">	<span class="keyword">if</span> items <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">		items = getattr(gevent_module, <span class="string">'__implements__'</span>, <span class="keyword">None</span>)</div><div class="line">		<span class="keyword">if</span> items <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">			<span class="keyword">raise</span> AttributeError(<span class="string">'%r does not have __implements__'</span> % gevent_module)</div><div class="line">	<span class="keyword">for</span> attr <span class="keyword">in</span> items:</div><div class="line">		patch_item(module, attr, getattr(gevent_module, attr))</div></pre></td></tr></table></figure></p>
<p>gevent有个约定，作为补丁的gevent模块要包含这两个属性，<code>__target__和__implements__</code>，<code>__target__</code>是被补丁的默认模块名称，可以不指定，默认为gevent子模块的名称，比如gevent.socket是socket模块的补丁，<br><code>__implements__</code>是要进行补丁的属性，这是gevent.socket模块中<code>__implements__</code>的定义：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># standard functions and classes that this module re-implements in a gevent-aware way:</span></div><div class="line">__implements__ = [<span class="string">'create_connection'</span>,</div><div class="line">                  <span class="string">'socket'</span>,</div><div class="line">                  <span class="string">'SocketType'</span>,</div><div class="line">                  <span class="string">'fromfd'</span>,</div><div class="line">                  <span class="string">'socketpair'</span>]</div></pre></td></tr></table></figure></p>
<p><code>patch_module</code>的工作就是从gevent模块里面读取这两个属性，然后遍历调用<code>patch_item</code>进行替换。</p>
<p>如果不希望用补丁的东西，而是使用原先的模块去进行处理，该怎么办？<br>前面提到过进行<code>patch_item</code>的时候会把旧的属性保存到名为saved的全局字典里面，如果要获得旧的模块属性，那么就要调用<code>get_original</code>函数从saved字典里面取出来。</p>
<h3 id="猴子补丁使用建议"><a href="#猴子补丁使用建议" class="headerlink" title="猴子补丁使用建议"></a>猴子补丁使用建议</h3><p>猴子补丁的功能很强大，但是也带来了很多的风险，尤其是像gevent这种直接进行API替换的补丁，整个Python进程所使用的模块都会被替换，可能自己的代码能hold住，但是其它第三方库，有时候问题并不好排查，即使排查出来也是很棘手，所以，就像松本建议的那样，如果要使用猴子补丁，那么<strong>只是做功能追加，尽量避免大规模的API覆盖</strong>。</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="http://www.tuicool.com/articles/ema22iM" target="_blank" rel="external">http://www.tuicool.com/articles/ema22iM</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/17/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/17/">17</a><span class="page-number current">18</span><a class="page-number" href="/page/19/">19</a><span class="space">&hellip;</span><a class="page-number" href="/page/29/">29</a><a class="extend next" rel="next" href="/page/19/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Arvin</p>
              <p class="site-description motion-element" itemprop="description">Learn and live.</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">141</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">5</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">33</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Arvin</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  












  





  

  

  
  

  

  

  

</body>
</html>
