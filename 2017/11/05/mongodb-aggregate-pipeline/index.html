<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Learn and live."><title>MongoDB之aggregate, pipeline及map_reduce | Simple &amp; Freedom</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">MongoDB之aggregate, pipeline及map_reduce</h1><a id="logo" href="/.">Simple &amp; Freedom</a><p class="description">Learn and live.</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/404.html"><i class="fa fa-heartbeat"> 公益404</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">MongoDB之aggregate, pipeline及map_reduce</h1><div class="post-meta">Nov 5, 2017<span> | </span><span class="category"><a href="/categories/数据库/">数据库</a></span></div><div class="post-content"><h3 id="MongoDB聚合"><a href="#MongoDB聚合" class="headerlink" title="MongoDB聚合"></a>MongoDB聚合</h3><p>聚合操作处理数据记录并返回计算结果。 聚合操作将多个文档中的值组合在一起，并可对分组数据执行各种操作，以返回单个结果。<br>在SQL中的 count(*)与group by组合相当于mongodb 中的聚合功能。</p>
<p>基本语法: <code>db.COLLECTION_NAME.aggregate(AGGREGATE_OPERATION)</code></p>
<h3 id="实例讲解"><a href="#实例讲解" class="headerlink" title="实例讲解"></a>实例讲解</h3><p>数据:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">   _id: 100, title: &apos;MongoDB Overview&apos;, description: &apos;MongoDB is no sql database&apos;, by_user: &apos;Maxsu&apos;, </div><div class="line">   url: &apos;http://www.yiibai.com&apos;, tags: [&apos;mongodb&apos;, &apos;database&apos;, &apos;NoSQL&apos;], likes: 100</div><div class="line">&#125;,</div><div class="line">&#123;</div><div class="line">   _id: 101, title: &apos;NoSQL Overview&apos;, description: &apos;No sql database is very fast&apos;, by_user: &apos;Maxsu&apos;,</div><div class="line">   url: &apos;http://www.yiibai.com&apos;, tags: [&apos;mongodb&apos;, &apos;database&apos;, &apos;NoSQL&apos;], likes: 10</div><div class="line">&#125;,</div><div class="line">&#123;</div><div class="line">   _id: 102, title: &apos;Neo4j Overview&apos;, description: &apos;Neo4j is no sql database&apos;, by_user: &apos;Kuber&apos;,</div><div class="line">   url: &apos;http://www.neo4j.com&apos;, tags: [&apos;neo4j&apos;, &apos;database&apos;, &apos;NoSQL&apos;], likes: 750</div><div class="line">&#125;,</div><div class="line">&#123;</div><div class="line">   _id: 103, title: &apos;MySQL Overview&apos;, description: &apos;MySQL is sql database&apos;, by_user: &apos;Curry&apos;,</div><div class="line">   url: &apos;http://www.yiibai.com/mysql/&apos;, tags: [&apos;MySQL&apos;, &apos;database&apos;, &apos;SQL&apos;], likes: 350</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>聚合字段<code>by_user</code>的总数, 其中<code>by_user</code>作为新集合的<code>_id</code>, 统计的总数放在num_tutorial字段的值中.<br><code>db.article.aggregate([{$group : {_id : &quot;$by_user&quot;, num_tutorial : {$sum : 1}}}])</code><br>结果如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&#123; &quot;_id&quot; : &quot;Curry&quot;, &quot;num_tutorial&quot; : 1 &#125;</div><div class="line">&#123; &quot;_id&quot; : &quot;Kuber&quot;, &quot;num_tutorial&quot; : 1 &#125;</div><div class="line">&#123; &quot;_id&quot; : &quot;Maxsu&quot;, &quot;num_tutorial&quot; : 2 &#125;</div></pre></td></tr></table></figure></p>
<p>上述用例的Sql等效查询<code>select by_user, count(*) as num_tutorial from</code>article<code>group by by_user;</code></p>
<h3 id="其他用于聚合的表达式"><a href="#其他用于聚合的表达式" class="headerlink" title="其他用于聚合的表达式"></a>其他用于聚合的表达式</h3><p>$sum    从集合中的所有文档中求出定义的值。 db.mycol.aggregate([{$group : {_id : “$by_user”, num_tutorial : {$sum : “$likes”}}}])<br>$avg    计算集合中所有文档的所有给定值的平均值。db.mycol.aggregate([{$group : {_id : “$by_user”, num_tutorial : {$avg : “$likes”}}}])<br>$min    从集合中的所有文档获取相应值的最小值。     db.mycol.aggregate([{$group : {_id : “$by_user”, num_tutorial : {$min : “$likes”}}}])<br>$max    从集合中的所有文档获取相应值的最大值。     db.mycol.aggregate([{$group : {_id : “$by_user”, num_tutorial : {$max : “$likes”}}}])<br>$push    将值插入到生成的文档中的数组中。       db.mycol.aggregate([{$group : {_id : “$by_user”, url : {$push: “$url”}}}])<br>$addToSet    将值插入生成的文档中的数组，但不会创建重复项。    db.mycol.aggregate([{$group : {_id : “$by_user”, url : {$addToSet : “$url”}}}])<br>$first    根据分组从源文档获取第一个文档。 通常情况下，这只适用于以前应用的“$sort”阶段。    db.mycol.aggregate([{$group : {_id : “$by_user”, first_url : {$first : “$url”}}}])<br>$last    根据分组从源文档获取最后一个文档。通常情况下，这只适用于以前应用的“$sort”阶段。    db.mycol.aggregate([{$group : {_id : “$by_user”, last_url : {$last : “$url”}}}])</p>
<h3 id="管道"><a href="#管道" class="headerlink" title="管道"></a>管道</h3><p>在UNIX命令中，shell管道可以对某些输入执行操作，并将输出用作下一个命令的输入。<br>MongoDB也在聚合框架中支持类似的概念。每一组输出可作为另一组文档的输入，并生成一组生成的文档(或最终生成的JSON文档在管道的末尾)。<br>这样就可以再次用于下一阶段等等。</p>
<p>以下是在聚合框架可能的阶段 -</p>
<p>$project - 用于从集合中选择一些特定字段。<br>$match - 这是一个过滤操作，因此可以减少作为下一阶段输入的文档数量。<br>$group - 这是上面讨论的实际聚合。<br>$sort - 排序文档。<br>$skip - 通过这种方式，可以在给定数量的文档的文档列表中向前跳过。<br>$limit - 限制从当前位置开始的给定数量的文档数量。<br>$unwind - 用于展开正在使用数组的文档。使用数组时，数据是预先加入的，此操作将被撤销，以便再次单独使用文档。 因此，在这个阶段，将增加下一阶段的文件数量。</p>
<h3 id="map-reduce"><a href="#map-reduce" class="headerlink" title="map_reduce"></a>map_reduce</h3><p>Map-reduce是将大量数据合并为有用的聚合结果的数据处理范例。 MongoDB使用mapReduce命令进行map-reduce操作。MapReduce通常用于处理大型数据集。<br>MapReduce命令:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">db.collection.mapReduce(</div><div class="line">   function() &#123;emit(key,value);&#125;,  //map function</div><div class="line">   function(key,values) &#123;return reduceFunction&#125;, //reduce function</div><div class="line">   &#123;</div><div class="line">    query: query,  </div><div class="line">    out: out,    //指定结果集以什么方式存储，可选参数包括：  </div><div class="line">                //replace:如果文档(table)存在，则替换table，  </div><div class="line">                //merge:如果文档中存在记录，则覆盖已存在的文档记录  </div><div class="line">                //reduce: 如果文档中存在相同key的记录了，则先计算两条记录，然后覆盖旧记录  </div><div class="line">                // &#123;inline:1&#125;  在内存中存储记录，不写入磁盘(用户数据量少的计算) </div><div class="line">    sort: sort,  </div><div class="line">    limit: limit,  </div><div class="line">    finalize: function  //这个function主要用来在存入out之前可以修改数据，function(key,values) &#123;   </div><div class="line">                        //return modifiedValues;&#125;  </div><div class="line">    scope: document,    //设置参数值，在这里设置的值在map，reduce，finalize函数中可见</div><div class="line">    jsMode:boolean      //是否减少执行过程中BSON和JS的转换，默认true]</div><div class="line">                        //false时 BSON--&gt;JS--&gt;map--&gt;BSON--&gt;JS--&gt;reduce--&gt;BSON,可处理非常大的mapreduce,</div><div class="line">                        //true时BSON--&gt;js--&gt;map--&gt;reduce--&gt;BSON</div><div class="line">                        </div><div class="line">    verbose:boolean     //是否产生更加详细的服务器日志，默认true</div><div class="line">    keytemp：boolean    //true或false，表明结果输出到的collection是否是临时的，如果为true，则会在客户端连接中断后自动删除，如果你用的是MongoDB的mongo客户端连接，  </div><div class="line">                        //那必须exit后才会删除。如果是脚本执行，脚本退出或调用close会自动删除结果collection    </div><div class="line"></div><div class="line">   &#125;</div><div class="line">)</div><div class="line"></div><div class="line">必备参数：map,reduce, out</div></pre></td></tr></table></figure></p>
<p><code>map: function() {emit(this.cat_id,this.goods_number); }</code><br>说明: 函数内部要调用内置的emit函数,cat_id代表根据cat_id来进行分组,<br>goods_number代表把文档中的goods_number字段映射到cat_id分组上的数据,<br>其中this是指向向前的文档的,这里的第二个参数可以是一个对象,如果是一个对象的话,也是作为数组的元素压进数组里面;</p>
<p>reduce: function(cat_id,all_goods_number) {return Array.sum(all_goods_number)},<br>cat_id代表着cat_id当前的这一组,all_goods_number代表当前这一组的goods_number集合,这部分返回的就是结果中的value值;</p>
<p>out: <output>, // 输出到某一个集合中,注意本属性来还支持如果输出的集合如果已经存在了,那是替换,合并还是继续reduce? 另外还支持输出到其他db的分片中,具体用到时查阅文档,筛选出现的键名分别是_id和value;</output></p>
<p>query: <document>, // 一个查询表达式,是先查询出来,再进行mapReduce的</document></p>
<p>sort: <document>, // 发往map函数前先给文档排序</document></p>
<p>limit: <number>, // 发往map函数的文档数量上限,该参数貌似不能用在分片模式下的mapreduce</number></p>
<p>finalize: function(key, reducedValue) {return modifiedObject; }, // 从reduce函数中接受的参数key与reducedValue,并且可以访问scope中设定的变量</p>
<p>scope: <document>, // 指定一个全局变量,能应用于finalize和reduce函数</document></p>
<p>jsMode: <boolean>, // 布尔值，是否减少执行过程中BSON和JS的转换，默认true,true时BSON–&gt;js–&gt;map–&gt;reduce–&gt;BSON,false时 BSON–&gt;JS–&gt;map–&gt;BSON–&gt;JS–&gt;reduce–&gt;BSON,可处理非常大的mapreduce。</boolean></p>
<p>verbose: <boolean> // 是否产生更加详细的服务器日志，默认true</boolean></p>
<p>map-reduce函数首先查询集合，然后将结果文档映射到发出的键值对，然后根据具有多个值的键进行减少。</p>
<ul>
<li>map是一个JavaScript函数，它将一个值与一个键映射并发出一个键值对；</li>
<li>reduce是一个javascript函数，可以减少或分组具有相同键的所有文档；</li>
<li>out指定map-reduce查询结果的输出位置,一般是输出到另一个新的集合里；</li>
<li>query指定选择文档的可选选择条件；</li>
<li>sort指定可选的排序条件；</li>
<li>limit指定可选的最大文档数；</li>
</ul>
<p>MapReduce查询可用于构建大型复杂聚合查询。 使用自定义JavaScript函数可以使用MapReduce，它非常灵活和强大。</p>
</div><div class="tags"><a href="/tags/MongoDB/">MongoDB</a></div><div class="post-nav"><a href="/2017/11/06/someconcept-2017-11-06/" class="pre">Linux IO模式及 select、poll、epoll详解</a><a href="/2017/10/31/libuv-libev-epoll-select-2017-10-31/" class="next">libuv与libev,epoll与select</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Web/">Web</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/js/">js</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/node-js/">node.js</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/web/">web</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/工具/">工具</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/思想/">思想</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据库/">数据库</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/编程/">编程</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/随笔/">随笔</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/Python/" style="font-size: 15px;">Python</a> <a href="/tags/算法/" style="font-size: 15px;">算法</a> <a href="/tags/node-js/" style="font-size: 15px;">node.js</a> <a href="/tags/计算机基础/" style="font-size: 15px;">计算机基础</a> <a href="/tags/谷歌/" style="font-size: 15px;">谷歌</a> <a href="/tags/C-C/" style="font-size: 15px;">C/C++</a> <a href="/tags/OOP/" style="font-size: 15px;">OOP</a> <a href="/tags/css/" style="font-size: 15px;">css</a> <a href="/tags/设计模式/" style="font-size: 15px;">设计模式</a> <a href="/tags/Flask/" style="font-size: 15px;">Flask</a> <a href="/tags/Git/" style="font-size: 15px;">Git</a> <a href="/tags/Hexo/" style="font-size: 15px;">Hexo</a> <a href="/tags/HTML/" style="font-size: 15px;">HTML</a> <a href="/tags/http/" style="font-size: 15px;">http</a> <a href="/tags/方法/" style="font-size: 15px;">方法</a> <a href="/tags/js/" style="font-size: 15px;">js</a> <a href="/tags/Vue/" style="font-size: 15px;">Vue</a> <a href="/tags/MongoDB/" style="font-size: 15px;">MongoDB</a> <a href="/tags/Markdown/" style="font-size: 15px;">Markdown</a> <a href="/tags/MySQL/" style="font-size: 15px;">MySQL</a> <a href="/tags/NodeJS/" style="font-size: 15px;">NodeJS</a> <a href="/tags/NSIS/" style="font-size: 15px;">NSIS</a> <a href="/tags/web/" style="font-size: 15px;">web</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/scrapy/" style="font-size: 15px;">scrapy</a> <a href="/tags/PyQt5/" style="font-size: 15px;">PyQt5</a> <a href="/tags/redis/" style="font-size: 15px;">redis</a> <a href="/tags/RegExp/" style="font-size: 15px;">RegExp</a> <a href="/tags/爬虫/" style="font-size: 15px;">爬虫</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/Tools/" style="font-size: 15px;">Tools</a> <a href="/tags/SVN/" style="font-size: 15px;">SVN</a> <a href="/tags/tornado/" style="font-size: 15px;">tornado</a> <a href="/tags/Web/" style="font-size: 15px;">Web</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/01/25/linux-crontab-2018-01-25/">linux之crontab使用</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/16/py-scrapy2-2018-01-16/">scrapy笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/15/py-scrapy1-2018-01-15/">scrapy笔记-安装</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/15/py-pipcmds-2018-01-15/">python之pip常用命令</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/11/css-note1-2018-01-11/">css笔记1</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/11/selenium-phatomjs-2017-12-11/">selenium-phatomjs使用</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/08/jQuery-notes1-2017-12-08/">jQuery笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/08/js-dom-2017-12-08/">javascript之DOM操作</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/08/appium-notes1-2017-12-08/">Appium笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/08/js-object-2017-12-08/">javascript 标准对象</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">Simple &amp; Freedom.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.css"><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>